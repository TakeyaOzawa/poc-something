<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="systemSettings">システム設定</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body style="background: var(--color-background); min-height: 100vh;">
  <div x-data="systemSettingsApp()" class="min-h-screen">
    
    <!-- Header -->
    <header class="nav-header">
      <div class="flex items-center gap-3">
        <a href="popup.html" class="nav-back">
          <span>←</span>
          <span data-i18n="back">戻る</span>
        </a>
        <div class="nav-title">
          <span>⚙️</span>
          <span data-i18n="systemSettings">システム設定</span>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn btn-secondary btn-sm" @click="importSettings()">
          <span>📥</span>
          <span data-i18n="import">インポート</span>
        </button>
        <button class="btn btn-secondary btn-sm" @click="exportSettings()">
          <span>📤</span>
          <span data-i18n="export">エクスポート</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container py-6">
      <div class="tab-container">
        
        <!-- Tab Navigation -->
        <nav class="tab-nav">
          <button 
            class="tab-button"
            :class="{ 'active': activeTab === 'general' }"
            @click="activeTab = 'general'"
          >
            <span>⚙️</span>
            <span data-i18n="generalSettings">一般設定</span>
          </button>
          <button 
            class="tab-button"
            :class="{ 'active': activeTab === 'retry' }"
            @click="activeTab = 'retry'"
          >
            <span>🔄</span>
            <span data-i18n="retrySettings">リトライ設定</span>
          </button>
          <button 
            class="tab-button"
            :class="{ 'active': activeTab === 'security' }"
            @click="activeTab = 'security'"
          >
            <span>🔐</span>
            <span data-i18n="securitySettings">セキュリティ設定</span>
          </button>
        </nav>

        <!-- General Settings Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'general' }">
          <div class="space-y-8">
            
            <!-- Language Settings -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🌐</span>
                <span data-i18n="languageSettings">言語設定</span>
              </h3>
              <div class="card">
                <div class="card-body">
                  <div class="form-group">
                    <label class="form-label" data-i18n="language">言語</label>
                    <select class="form-select" x-model="settings.language">
                      <option value="ja">日本語</option>
                      <option value="en">English</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

            <!-- Theme Settings -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🎨</span>
                <span data-i18n="themeSettings">テーマ設定</span>
              </h3>
              <div class="card">
                <div class="card-body">
                  <div class="form-group">
                    <label class="form-label" data-i18n="theme">テーマ</label>
                    <select class="form-select" x-model="settings.theme">
                      <option value="light" data-i18n="themeLight">ライト</option>
                      <option value="dark" data-i18n="themeDark">ダーク</option>
                      <option value="system" data-i18n="themeSystem">システム設定に従う</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

            <!-- Notification Settings -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🔔</span>
                <span data-i18n="notificationSettings">通知設定</span>
              </h3>
              <div class="card">
                <div class="card-body space-y-4">
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.notifications.onComplete">
                    <label data-i18n="notifyOnComplete">実行完了時に通知を表示</label>
                  </div>
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.notifications.onError">
                    <label data-i18n="notifyOnError">エラー発生時に通知を表示</label>
                  </div>
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.notifications.onLongRunning">
                    <label data-i18n="notifyOnLongRunning">長時間実行時（5分以上）に進捗通知</label>
                  </div>
                  <div class="form-group">
                    <label class="form-label" data-i18n="notificationSound">通知音</label>
                    <select class="form-select" x-model="settings.notifications.sound">
                      <option value="enabled" data-i18n="enabled">有効</option>
                      <option value="disabled" data-i18n="disabled">無効</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

            <!-- Display Settings -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🖥️</span>
                <span data-i18n="displaySettings">表示設定</span>
              </h3>
              <div class="card">
                <div class="card-body space-y-4">
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.display.autoRefresh">
                    <label data-i18n="autoRefreshOnStartup">ポップアップ起動時にサイト一覧を自動更新</label>
                  </div>
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.display.debugMode">
                    <label data-i18n="debugMode">デバッグモード（詳細ログ表示）</label>
                  </div>
                  <div class="form-group">
                    <label class="form-label" data-i18n="historyRetention">実行履歴の保持期間</label>
                    <select class="form-select" x-model="settings.display.historyRetention">
                      <option value="7" data-i18n="days7">7日</option>
                      <option value="14" data-i18n="days14">14日</option>
                      <option value="30" data-i18n="days30">30日</option>
                      <option value="60" data-i18n="days60">60日</option>
                      <option value="-1" data-i18n="unlimited">無制限</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>

        <!-- Retry Settings Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'retry' }">
          <div class="space-y-8">
            
            <!-- Retry Behavior -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🔄</span>
                <span data-i18n="retryBehavior">リトライ動作</span>
              </h3>
              <div class="card">
                <div class="card-body">
                  <div class="form-group">
                    <label class="form-label" data-i18n="retryCount">リトライ回数</label>
                    <select class="form-select" x-model="settings.retry.count">
                      <option value="0">0回</option>
                      <option value="1">1回</option>
                      <option value="2">2回</option>
                      <option value="3">3回</option>
                      <option value="5">5回</option>
                      <option value="10">10回</option>
                      <option value="-1" data-i18n="infinite">無限回</option>
                    </select>
                    <div class="text-caption mt-2 p-3 rounded" style="background: var(--color-warning); color: var(--color-warning);">
                      <span>⚠️</span>
                      <span data-i18n="infiniteRetryWarning">無限回に設定すると、成功するまでリトライし続けます。リスク: 無限ループの可能性があります</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Retry Wait Time -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>⏱️</span>
                <span data-i18n="retryWaitTime">リトライ待機時間</span>
              </h3>
              <div class="card">
                <div class="card-body space-y-4">
                  <div class="form-group">
                    <label class="form-label" data-i18n="minWaitTime">最小待機時間（秒）</label>
                    <input type="number" class="form-input" x-model="settings.retry.minWait" min="1" max="300">
                  </div>
                  <div class="form-group">
                    <label class="form-label" data-i18n="maxWaitTime">最大待機時間（秒）</label>
                    <input type="number" class="form-input" x-model="settings.retry.maxWait" min="1" max="300">
                  </div>
                  <div class="text-caption p-3 rounded" style="background: var(--color-info); color: var(--color-info);">
                    <div class="mb-2">
                      <span>ℹ️</span>
                      <span data-i18n="retryWaitExplanation">リトライ時にランダムな待機時間を設定します（アンチボット対策）</span>
                    </div>
                    <div>
                      <span data-i18n="retryWaitExample">例: 最小30秒、最大60秒の場合 → 30〜60秒のランダムな時間待機します</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>

        <!-- Security Settings Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'security' }">
          <div class="space-y-8">
            
            <!-- Master Password -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🔑</span>
                <span data-i18n="masterPassword">マスターパスワード</span>
              </h3>
              <div class="card">
                <div class="card-body">
                  <div class="flex items-center justify-between mb-4">
                    <div>
                      <div class="text-body mb-1" data-i18n="masterPasswordStatus">マスターパスワード</div>
                      <div class="flex items-center gap-2">
                        <span class="status-badge status-success">
                          <span>✓</span>
                          <span data-i18n="configured">設定済み</span>
                        </span>
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button class="btn btn-secondary btn-sm" @click="changeMasterPassword()">
                        <span>🔄</span>
                        <span data-i18n="change">変更</span>
                      </button>
                      <button class="btn btn-danger btn-sm" @click="removeMasterPassword()">
                        <span>🗑️</span>
                        <span data-i18n="remove">削除</span>
                      </button>
                    </div>
                  </div>
                  <div class="text-caption p-3 rounded" style="background: var(--color-info); color: var(--color-info);">
                    <span>ℹ️</span>
                    <span data-i18n="masterPasswordInfo">マスターパスワードは変数の暗号化に使用されます</span>
                  </div>
                </div>
              </div>
            </section>

            <!-- Auto Lock -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🔒</span>
                <span data-i18n="autoLock">自動ロック</span>
              </h3>
              <div class="card">
                <div class="card-body space-y-4">
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.security.autoLock.enabled">
                    <label data-i18n="enableAutoLock">自動ロックを有効化</label>
                  </div>
                  <div class="form-group" x-show="settings.security.autoLock.enabled">
                    <label class="form-label" data-i18n="lockTimeout">ロックまでの時間</label>
                    <select class="form-select" x-model="settings.security.autoLock.timeout">
                      <option value="1" data-i18n="minutes1">1分</option>
                      <option value="5" data-i18n="minutes5">5分</option>
                      <option value="15" data-i18n="minutes15">15分</option>
                      <option value="30" data-i18n="minutes30">30分</option>
                      <option value="60" data-i18n="minutes60">60分</option>
                      <option value="-1" data-i18n="never">なし</option>
                    </select>
                  </div>
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.security.autoLock.onBrowserClose">
                    <label data-i18n="lockOnBrowserClose">ブラウザ終了時にロック</label>
                  </div>
                </div>
              </div>
            </section>

            <!-- Data Protection -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🛡️</span>
                <span data-i18n="dataProtection">データ保護</span>
              </h3>
              <div class="card">
                <div class="card-body space-y-4">
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.security.encryption.enabled">
                    <label data-i18n="enableEncryption">変数の暗号化を有効化（マスターパスワード必須）</label>
                  </div>
                  <div class="form-checkbox">
                    <input type="checkbox" x-model="settings.security.clipboard.autoClear">
                    <label data-i18n="autoClearClipboard">クリップボード履歴を5分後に自動削除</label>
                  </div>
                  <div class="form-group">
                    <label class="form-label" data-i18n="backupLocation">バックアップの保存先</label>
                    <select class="form-select" x-model="settings.security.backup.location">
                      <option value="local" data-i18n="localOnly">ローカルのみ</option>
                      <option value="chrome-sync" data-i18n="chromeSync">Chrome同期</option>
                      <option value="external" data-i18n="externalStorage">外部ストレージ</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

            <!-- Data Deletion -->
            <section>
              <h3 class="text-headline mb-4 flex items-center gap-2">
                <span>🗑️</span>
                <span data-i18n="dataDeletion">データ削除</span>
              </h3>
              <div class="card">
                <div class="card-body">
                  <button class="btn btn-danger w-full mb-4" @click="deleteAllData()">
                    <span>⚠️</span>
                    <span data-i18n="deleteAllData">すべてのデータを削除</span>
                  </button>
                  <div class="text-caption p-3 rounded" style="background: var(--color-error); color: var(--color-error);">
                    <div class="mb-2">
                      <span>ℹ️</span>
                      <span data-i18n="deleteAllDataInfo">以下がすべて削除されます:</span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                      <li data-i18n="websiteList">サイト一覧</li>
                      <li data-i18n="xpathSettings">XPath設定</li>
                      <li data-i18n="executionHistory">実行履歴</li>
                      <li data-i18n="systemSettings">システム設定</li>
                      <li data-i18n="masterPassword">マスターパスワード</li>
                    </ul>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>

      </div>
    </main>

    <!-- Action Bar -->
    <div class="sticky bottom-0 p-4 border-t" style="border-color: var(--color-outline-variant); background: var(--color-surface);">
      <div class="container flex justify-end gap-3">
        <button class="btn btn-secondary" @click="resetSettings()">
          <span>🔄</span>
          <span data-i18n="reset">リセット</span>
        </button>
        <button class="btn btn-primary" @click="saveSettings()">
          <span>💾</span>
          <span data-i18n="save">保存</span>
        </button>
      </div>
    </div>

  </div>

  <script>
    // Theme detection
    function detectTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Initial theme detection
    detectTheme();
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

    function systemSettingsApp() {
      return {
        activeTab: 'general',
        settings: {
          language: 'ja',
          theme: 'light',
          notifications: {
            onComplete: true,
            onError: true,
            onLongRunning: true,
            sound: 'enabled'
          },
          display: {
            autoRefresh: true,
            debugMode: false,
            historyRetention: '30'
          },
          retry: {
            count: '3',
            minWait: 30,
            maxWait: 60
          },
          security: {
            autoLock: {
              enabled: true,
              timeout: '15',
              onBrowserClose: true
            },
            encryption: {
              enabled: false
            },
            clipboard: {
              autoClear: false
            },
            backup: {
              location: 'local'
            }
          }
        },

        init() {
          this.loadSettings();
        },

        async loadSettings() {
          // Load settings from storage
          console.log('Loading settings...');
        },

        async saveSettings() {
          // Save settings to storage
          console.log('Saving settings...', this.settings);
          // Show success toast
          this.showToast('設定を保存しました', 'success');
        },

        resetSettings() {
          if (confirm('設定をリセットしますか？')) {
            // Reset to defaults
            this.init();
            this.showToast('設定をリセットしました', 'info');
          }
        },

        importSettings() {
          // Open file picker for import
          console.log('Import settings');
        },

        exportSettings() {
          // Export settings as JSON
          console.log('Export settings');
        },

        changeMasterPassword() {
          // Open master password change modal
          console.log('Change master password');
        },

        removeMasterPassword() {
          if (confirm('マスターパスワードを削除しますか？')) {
            console.log('Remove master password');
          }
        },

        deleteAllData() {
          if (confirm('すべてのデータを削除しますか？この操作は取り消せません。')) {
            console.log('Delete all data');
          }
        },

        showToast(message, type = 'info') {
          // Show toast notification
          console.log(`Toast: ${message} (${type})`);
        }
      };
    }
  </script>
</body>
</html>
