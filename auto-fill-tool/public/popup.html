<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="popupTitle">Auto-Fill Tool</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <script defer src="vendor/alpine.min.js"></script>
</head>
<body class="w-[420px] min-h-[600px]" style="background: var(--color-background);">
  <div x-data="popupApp()" class="h-full flex flex-col">
    
    <!-- Header -->
    <header class="nav-header">
      <div class="nav-title">
        <span class="text-2xl">ğŸ¯</span>
        <span data-i18n="popupTitle">Auto-Fill Tool</span>
      </div>
      <div class="nav-actions">
        <button class="btn btn-secondary btn-sm" id="settingsBtn" @click="openSettings()">
          <span>âš™ï¸</span>
          <span data-i18n="settingsButton">è¨­å®š</span>
        </button>
      </div>
    </header>

    <!-- Quick Actions -->
    <div class="p-4" style="background: var(--color-surface);">
      <div class="flex gap-2 mb-4">
        <button class="btn btn-primary flex-1" id="addWebsiteBtn" @click="showAddWebsiteModal = true">
          <span>â•</span>
          <span data-i18n="addWebsiteButton">ã‚µã‚¤ãƒˆè¿½åŠ </span>
        </button>
        <button class="btn btn-secondary" id="xpathManagerBtn" @click="openXPathManager()">
          <span>ğŸ”</span>
          <span data-i18n="xpathManagerButton">XPath</span>
        </button>
        <button class="btn btn-secondary" id="automationVariablesManagerBtn" @click="openExecutionHistory()">
          <span>ğŸ“‹</span>
          <span data-i18n="automationVariablesButton">å±¥æ­´</span>
        </button>
      </div>
      
      <!-- Search -->
      <div class="form-group">
        <input 
          type="text" 
          class="form-input" 
          placeholder="ã‚µã‚¤ãƒˆã‚’æ¤œç´¢..." 
          x-model="searchQuery"
          data-i18n-placeholder="searchWebsites"
        >
      </div>
    </div>

    <!-- Website List -->
    <div class="flex-1 p-4 overflow-y-auto">
      <!-- Empty State -->
      <div x-show="filteredWebsites.length === 0 && !isLoading" class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ“</div>
        <div class="text-title mb-2" data-i18n="noWebsitesRegistered">Webã‚µã‚¤ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        <div class="text-caption mb-6">ã€Œã‚µã‚¤ãƒˆè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        <button class="btn btn-primary" @click="showAddWebsiteModal = true">
          <span>â•</span>
          <span data-i18n="addWebsiteButton">ã‚µã‚¤ãƒˆè¿½åŠ </span>
        </button>
      </div>

      <!-- Loading State -->
      <div x-show="isLoading" class="text-center py-12">
        <div class="text-4xl mb-4">â³</div>
        <div class="text-body" data-i18n="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <!-- Website Cards -->
      <div class="space-y-3">
        <template x-for="website in filteredWebsites" :key="website.id">
          <div class="card hover:shadow-3 transition-all duration-200">
            <div class="card-body">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h3 class="text-title mb-1" x-text="website.name"></h3>
                  <p class="text-caption" x-text="website.startUrl"></p>
                </div>
                <div class="flex items-center gap-2">
                  <span 
                    class="status-badge"
                    :class="{
                      'status-success': website.status === 'enabled',
                      'status-warning': website.status === 'once',
                      'status-error': website.status === 'disabled'
                    }"
                    x-text="getStatusText(website.status)"
                  ></span>
                </div>
              </div>
              
              <div class="flex gap-2">
                <button 
                  class="btn btn-primary btn-sm flex-1"
                  @click="executeWebsite(website)"
                  :disabled="website.status === 'disabled'"
                >
                  <span>â–¶ï¸</span>
                  <span data-i18n="executeButton">å®Ÿè¡Œ</span>
                </button>
                <button 
                  class="btn btn-secondary btn-sm"
                  @click="editWebsite(website)"
                >
                  <span>âœï¸</span>
                  <span data-i18n="editButton">ç·¨é›†</span>
                </button>
                <button 
                  class="btn btn-danger btn-sm"
                  @click="deleteWebsite(website)"
                >
                  <span>ğŸ—‘ï¸</span>
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Footer -->
    <footer class="p-4 border-t" style="border-color: var(--color-outline-variant); background: var(--color-surface);">
      <div class="flex items-center justify-between text-caption">
        <div class="flex items-center gap-4">
          <button class="nav-back" id="securityLogViewerBtn" @click="openSecurityLogs()">
            <span>ğŸ”’</span>
            <span data-i18n="securityLogViewerButton">ãƒ­ã‚°</span>
          </button>
          <button class="nav-back" id="dataSyncBtn" @click="openDataSync()">
            <span>ğŸ”„</span>
            <span data-i18n="dataSyncButton">åŒæœŸ</span>
          </button>
          <button class="nav-back" id="performanceDashboardBtn" @click="openPerformanceDashboard()">
            <span>ğŸ“Š</span>
            <span data-i18n="performanceDashboard">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</span>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <span data-i18n="language">ğŸŒ Language</span>
          <select class="form-select" style="width: auto; padding: 4px 8px; font-size: 12px;">
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
    </footer>

    <!-- Add Website Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showAddWebsiteModal }"
      @click.self="showAddWebsiteModal = false"
    >
      <div class="modal" style="width: 480px;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="addWebsiteTitle">ã‚µã‚¤ãƒˆè¿½åŠ </h2>
          <button class="modal-close" @click="showAddWebsiteModal = false">âœ•</button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="addWebsite()">
            <div class="form-group">
              <label class="form-label" data-i18n="websiteName">ã‚µã‚¤ãƒˆå</label>
              <input 
                type="text" 
                class="form-input" 
                x-model="newWebsite.name"
                placeholder="ä¾‹: ãƒ­ã‚°ã‚¤ãƒ³ã‚µã‚¤ãƒˆ"
                required
              >
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="startUrl">é–‹å§‹URL</label>
              <input 
                type="url" 
                class="form-input" 
                x-model="newWebsite.startUrl"
                placeholder="https://example.com/login"
                required
              >
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="form-select" x-model="newWebsite.status">
                <option value="enabled" data-i18n="statusEnabled">æœ‰åŠ¹</option>
                <option value="disabled" data-i18n="statusDisabled">ç„¡åŠ¹</option>
                <option value="once" data-i18n="statusOnce">1å›ã®ã¿</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="showAddWebsiteModal = false">
            <span data-i18n="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          </button>
          <button class="btn btn-primary" @click="addWebsite()">
            <span>â•</span>
            <span data-i18n="add">è¿½åŠ </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Execution Progress Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showExecutionModal }"
    >
      <div class="modal" style="width: 480px;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="executionProgress">å®Ÿè¡Œä¸­</h2>
        </div>
        <div class="modal-body text-center">
          <div class="text-6xl mb-4">âš¡</div>
          <div class="text-title mb-2" x-text="executionStatus.siteName"></div>
          <div class="text-body mb-4" x-text="executionStatus.message"></div>
          
          <!-- Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div 
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              :style="`width: ${executionStatus.progress}%`"
            ></div>
          </div>
          
          <div class="text-caption" x-text="`${executionStatus.currentStep} / ${executionStatus.totalSteps} ã‚¹ãƒ†ãƒƒãƒ—`"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" @click="cancelExecution()">
            <span>â¸ï¸</span>
            <span data-i18n="cancel">åœæ­¢</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Theme detection
    function detectTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Initial theme detection
    detectTheme();
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

    function popupApp() {
      return {
        websites: [],
        searchQuery: '',
        isLoading: true,
        showAddWebsiteModal: false,
        showExecutionModal: false,
        newWebsite: {
          name: '',
          startUrl: '',
          status: 'enabled'
        },
        executionStatus: {
          siteName: '',
          message: '',
          progress: 0,
          currentStep: 0,
          totalSteps: 0
        },

        get filteredWebsites() {
          if (!this.searchQuery) return this.websites;
          return this.websites.filter(site => 
            site.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            site.startUrl.toLowerCase().includes(this.searchQuery.toLowerCase())
          );
        },

        init() {
          this.loadWebsites();
        },

        async loadWebsites() {
          this.isLoading = true;
          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            this.websites = [
              { id: '1', name: 'ãƒ­ã‚°ã‚¤ãƒ³ã‚µã‚¤ãƒˆ', startUrl: 'https://example.com/login', status: 'enabled' },
              { id: '2', name: 'ãƒ•ã‚©ãƒ¼ãƒ ã‚µã‚¤ãƒˆ', startUrl: 'https://form.example.com', status: 'once' },
              { id: '3', name: 'ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆ', startUrl: 'https://test.example.com', status: 'disabled' }
            ];
          } catch (error) {
            console.error('Failed to load websites:', error);
          } finally {
            this.isLoading = false;
          }
        },

        getStatusText(status) {
          const statusMap = {
            'enabled': 'æœ‰åŠ¹',
            'disabled': 'ç„¡åŠ¹',
            'once': '1å›ã®ã¿'
          };
          return statusMap[status] || status;
        },

        async addWebsite() {
          if (!this.newWebsite.name || !this.newWebsite.startUrl) return;
          
          const website = {
            id: Date.now().toString(),
            ...this.newWebsite
          };
          
          this.websites.push(website);
          this.showAddWebsiteModal = false;
          this.newWebsite = { name: '', startUrl: '', status: 'enabled' };
        },

        async executeWebsite(website) {
          this.executionStatus = {
            siteName: website.name,
            message: 'å®Ÿè¡Œã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...',
            progress: 0,
            currentStep: 0,
            totalSteps: 10
          };
          this.showExecutionModal = true;

          // Simulate execution progress
          for (let i = 1; i <= 10; i++) {
            await new Promise(resolve => setTimeout(resolve, 500));
            this.executionStatus.currentStep = i;
            this.executionStatus.progress = (i / 10) * 100;
            this.executionStatus.message = `ã‚¹ãƒ†ãƒƒãƒ— ${i} ã‚’å®Ÿè¡Œä¸­...`;
          }

          this.executionStatus.message = 'å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼';
          setTimeout(() => {
            this.showExecutionModal = false;
          }, 2000);
        },

        editWebsite(website) {
          // Open edit modal or navigate to edit page
          console.log('Edit website:', website);
        },

        deleteWebsite(website) {
          if (confirm(`ã€Œ${website.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            this.websites = this.websites.filter(w => w.id !== website.id);
          }
        },

        cancelExecution() {
          this.showExecutionModal = false;
        },

        openSettings() {
          chrome.tabs.create({ url: 'system-settings.html' });
        },

        openXPathManager() {
          chrome.tabs.create({ url: 'xpath-manager.html' });
        },

        openExecutionHistory() {
          chrome.tabs.create({ url: 'automation-variables-manager.html' });
        },

        openSecurityLogs() {
          chrome.tabs.create({ url: 'security-log-viewer.html' });
        },

        openDataSync() {
          chrome.tabs.create({ url: 'storage-sync-manager.html' });
        },

        openPerformanceDashboard() {
          chrome.tabs.create({ url: 'performance-dashboard.html' });
        }
      };
    }
  </script>
</body>
</html>
