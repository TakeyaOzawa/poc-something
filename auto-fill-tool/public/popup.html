<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="popupTitle">Auto-Fill Tool</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="w-[420px] min-h-[600px]" style="background: var(--color-background);">
  <div x-data="popupApp()" class="h-full flex flex-col">
    
    <!-- Header -->
    <header class="nav-header">
      <div class="nav-title">
        <span class="text-2xl">🎯</span>
        <span data-i18n="popupTitle">Auto-Fill Tool</span>
      </div>
      <div class="nav-actions">
        <button class="btn btn-secondary btn-sm" id="settingsBtn" @click="openSettings()">
          <span>⚙️</span>
          <span data-i18n="settingsButton">設定</span>
        </button>
      </div>
    </header>

    <!-- Quick Actions -->
    <div class="p-4" style="background: var(--color-surface);">
      <div class="flex gap-2 mb-4">
        <button class="btn btn-primary flex-1" id="addWebsiteBtn" @click="showAddWebsiteModal = true">
          <span>➕</span>
          <span data-i18n="addWebsiteButton">サイト追加</span>
        </button>
        <button class="btn btn-secondary" id="xpathManagerBtn" @click="openXPathManager()">
          <span>🔍</span>
          <span data-i18n="xpathManagerButton">XPath</span>
        </button>
        <button class="btn btn-secondary" id="automationVariablesManagerBtn" @click="openExecutionHistory()">
          <span>📋</span>
          <span data-i18n="automationVariablesButton">履歴</span>
        </button>
      </div>
      
      <!-- Search -->
      <div class="form-group">
        <input 
          type="text" 
          class="form-input" 
          placeholder="サイトを検索..." 
          x-model="searchQuery"
          data-i18n-placeholder="searchWebsites"
        >
      </div>
    </div>

    <!-- Website List -->
    <div class="flex-1 p-4 overflow-y-auto">
      <!-- Empty State -->
      <div x-show="filteredWebsites.length === 0 && !isLoading" class="text-center py-12">
        <div class="text-6xl mb-4">📝</div>
        <div class="text-title mb-2" data-i18n="noWebsitesRegistered">Webサイトが登録されていません</div>
        <div class="text-caption mb-6">「サイト追加」ボタンから登録してください</div>
        <button class="btn btn-primary" @click="showAddWebsiteModal = true">
          <span>➕</span>
          <span data-i18n="addWebsiteButton">サイト追加</span>
        </button>
      </div>

      <!-- Loading State -->
      <div x-show="isLoading" class="text-center py-12">
        <div class="text-4xl mb-4">⏳</div>
        <div class="text-body" data-i18n="loading">読み込み中...</div>
      </div>

      <!-- Website Cards -->
      <div class="space-y-3">
        <template x-for="website in filteredWebsites" :key="website.id">
          <div class="card hover:shadow-3 transition-all duration-200">
            <div class="card-body">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h3 class="text-title mb-1" x-text="website.name"></h3>
                  <p class="text-caption" x-text="website.startUrl"></p>
                </div>
                <div class="flex items-center gap-2">
                  <span 
                    class="status-badge"
                    :class="{
                      'status-success': website.status === 'enabled',
                      'status-warning': website.status === 'once',
                      'status-error': website.status === 'disabled'
                    }"
                    x-text="getStatusText(website.status)"
                  ></span>
                </div>
              </div>
              
              <div class="flex gap-2">
                <button 
                  class="btn btn-primary btn-sm flex-1"
                  @click="executeWebsite(website)"
                  :disabled="website.status === 'disabled'"
                >
                  <span>▶️</span>
                  <span data-i18n="executeButton">実行</span>
                </button>
                <button 
                  class="btn btn-secondary btn-sm"
                  @click="editWebsite(website)"
                >
                  <span>✏️</span>
                  <span data-i18n="editButton">編集</span>
                </button>
                <button 
                  class="btn btn-danger btn-sm"
                  @click="deleteWebsite(website)"
                >
                  <span>🗑️</span>
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Footer -->
    <footer class="p-4 border-t" style="border-color: var(--color-outline-variant); background: var(--color-surface);">
      <div class="flex items-center justify-between text-caption">
        <div class="flex items-center gap-4">
          <button class="nav-back" id="securityLogViewerBtn" @click="openSecurityLogs()">
            <span>🔒</span>
            <span data-i18n="securityLogViewerButton">ログ</span>
          </button>
          <button class="nav-back" id="dataSyncBtn" @click="openDataSync()">
            <span>🔄</span>
            <span data-i18n="dataSyncButton">同期</span>
          </button>
          <button class="nav-back" id="performanceDashboardBtn" @click="openPerformanceDashboard()">
            <span>📊</span>
            <span data-i18n="performanceDashboard">パフォーマンス</span>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <span data-i18n="language">🌐 Language</span>
          <select class="form-select" style="width: auto; padding: 4px 8px; font-size: 12px;">
            <option value="ja">日本語</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
    </footer>

    <!-- Add Website Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showAddWebsiteModal }"
      @click.self="showAddWebsiteModal = false"
    >
      <div class="modal" style="width: 480px;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="addWebsiteTitle">サイト追加</h2>
          <button class="modal-close" @click="showAddWebsiteModal = false">✕</button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="addWebsite()">
            <div class="form-group">
              <label class="form-label" data-i18n="websiteName">サイト名</label>
              <input 
                type="text" 
                class="form-input" 
                x-model="newWebsite.name"
                placeholder="例: ログインサイト"
                required
              >
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="startUrl">開始URL</label>
              <input 
                type="url" 
                class="form-input" 
                x-model="newWebsite.startUrl"
                placeholder="https://example.com/login"
                required
              >
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="status">ステータス</label>
              <select class="form-select" x-model="newWebsite.status">
                <option value="enabled" data-i18n="statusEnabled">有効</option>
                <option value="disabled" data-i18n="statusDisabled">無効</option>
                <option value="once" data-i18n="statusOnce">1回のみ</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="showAddWebsiteModal = false">
            <span data-i18n="cancel">キャンセル</span>
          </button>
          <button class="btn btn-primary" @click="addWebsite()">
            <span>➕</span>
            <span data-i18n="add">追加</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Execution Progress Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showExecutionModal }"
    >
      <div class="modal" style="width: 480px;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="executionProgress">実行中</h2>
        </div>
        <div class="modal-body text-center">
          <div class="text-6xl mb-4">⚡</div>
          <div class="text-title mb-2" x-text="executionStatus.siteName"></div>
          <div class="text-body mb-4" x-text="executionStatus.message"></div>
          
          <!-- Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div 
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              :style="`width: ${executionStatus.progress}%`"
            ></div>
          </div>
          
          <div class="text-caption" x-text="`${executionStatus.currentStep} / ${executionStatus.totalSteps} ステップ`"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" @click="cancelExecution()">
            <span>⏸️</span>
            <span data-i18n="cancel">停止</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Theme detection
    function detectTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Initial theme detection
    detectTheme();
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

    function popupApp() {
      return {
        websites: [],
        searchQuery: '',
        isLoading: true,
        showAddWebsiteModal: false,
        showExecutionModal: false,
        newWebsite: {
          name: '',
          startUrl: '',
          status: 'enabled'
        },
        executionStatus: {
          siteName: '',
          message: '',
          progress: 0,
          currentStep: 0,
          totalSteps: 0
        },

        get filteredWebsites() {
          if (!this.searchQuery) return this.websites;
          return this.websites.filter(site => 
            site.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            site.startUrl.toLowerCase().includes(this.searchQuery.toLowerCase())
          );
        },

        init() {
          this.loadWebsites();
        },

        async loadWebsites() {
          this.isLoading = true;
          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            this.websites = [
              { id: '1', name: 'ログインサイト', startUrl: 'https://example.com/login', status: 'enabled' },
              { id: '2', name: 'フォームサイト', startUrl: 'https://form.example.com', status: 'once' },
              { id: '3', name: 'テストサイト', startUrl: 'https://test.example.com', status: 'disabled' }
            ];
          } catch (error) {
            console.error('Failed to load websites:', error);
          } finally {
            this.isLoading = false;
          }
        },

        getStatusText(status) {
          const statusMap = {
            'enabled': '有効',
            'disabled': '無効',
            'once': '1回のみ'
          };
          return statusMap[status] || status;
        },

        async addWebsite() {
          if (!this.newWebsite.name || !this.newWebsite.startUrl) return;
          
          const website = {
            id: Date.now().toString(),
            ...this.newWebsite
          };
          
          this.websites.push(website);
          this.showAddWebsiteModal = false;
          this.newWebsite = { name: '', startUrl: '', status: 'enabled' };
        },

        async executeWebsite(website) {
          this.executionStatus = {
            siteName: website.name,
            message: '実行を開始しています...',
            progress: 0,
            currentStep: 0,
            totalSteps: 10
          };
          this.showExecutionModal = true;

          // Simulate execution progress
          for (let i = 1; i <= 10; i++) {
            await new Promise(resolve => setTimeout(resolve, 500));
            this.executionStatus.currentStep = i;
            this.executionStatus.progress = (i / 10) * 100;
            this.executionStatus.message = `ステップ ${i} を実行中...`;
          }

          this.executionStatus.message = '実行が完了しました！';
          setTimeout(() => {
            this.showExecutionModal = false;
          }, 2000);
        },

        editWebsite(website) {
          // Open edit modal or navigate to edit page
          console.log('Edit website:', website);
        },

        deleteWebsite(website) {
          if (confirm(`「${website.name}」を削除しますか？`)) {
            this.websites = this.websites.filter(w => w.id !== website.id);
          }
        },

        cancelExecution() {
          this.showExecutionModal = false;
        },

        openSettings() {
          chrome.tabs.create({ url: 'system-settings.html' });
        },

        openXPathManager() {
          chrome.tabs.create({ url: 'xpath-manager.html' });
        },

        openExecutionHistory() {
          chrome.tabs.create({ url: 'automation-variables-manager.html' });
        },

        openSecurityLogs() {
          chrome.tabs.create({ url: 'security-log-viewer.html' });
        },

        openDataSync() {
          chrome.tabs.create({ url: 'storage-sync-manager.html' });
        },

        openPerformanceDashboard() {
          chrome.tabs.create({ url: 'performance-dashboard.html' });
        }
      };
    }
  </script>
</body>
</html>
