<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="executionHistory">実行履歴</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* Execution History Specific Styles */
    .history-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-1);
      border: 1px solid var(--color-outline-variant);
      transition: all var(--transition-base);
      overflow: hidden;
    }
    
    .history-card:hover {
      box-shadow: var(--shadow-2);
      transform: translateY(-1px);
    }
    
    .history-card-header {
      padding: var(--spacing-4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--color-outline-variant);
    }
    
    .history-card-body {
      padding: var(--spacing-4);
    }
    
    .history-card-footer {
      padding: var(--spacing-3) var(--spacing-4);
      background: var(--color-surface-variant);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .execution-status {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      font-weight: 500;
    }
    
    .execution-status.success {
      color: var(--color-success);
    }
    
    .execution-status.error {
      color: var(--color-error);
    }
    
    .execution-status.running {
      color: var(--color-info);
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--color-outline-variant);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--color-primary);
      transition: width var(--transition-base);
    }
    
    .progress-fill.success {
      background: var(--color-success);
    }
    
    .progress-fill.error {
      background: var(--color-error);
    }
    
    .filter-bar {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-4);
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-outline-variant);
      flex-wrap: wrap;
    }
    
    .filter-chips {
      display: flex;
      gap: var(--spacing-2);
    }
    
    .filter-chip {
      padding: var(--spacing-2) var(--spacing-3);
      font-size: var(--font-size-sm);
      font-weight: 500;
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-on-surface-variant);
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .filter-chip:hover {
      background: var(--color-primary-container);
      border-color: var(--color-primary);
    }
    
    .filter-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-2);
      padding: var(--spacing-4);
      background: var(--color-surface);
      border-top: 1px solid var(--color-outline-variant);
    }
    
    .pagination-button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-on-surface-variant);
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .pagination-button:hover:not(:disabled) {
      background: var(--color-primary-container);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .pagination-button.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .pagination-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body style="background: var(--color-background); min-height: 100vh;">
  <div x-data="executionHistoryApp()" class="min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="nav-header">
      <div class="flex items-center gap-3">
        <a href="popup.html" class="nav-back">
          <span>←</span>
          <span data-i18n="back">戻る</span>
        </a>
        <div class="nav-title">
          <span>📋</span>
          <span data-i18n="executionHistory">実行履歴</span>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn btn-secondary btn-sm" @click="refreshHistory()">
          <span>🔄</span>
          <span data-i18n="refresh">更新</span>
        </button>
        <button class="btn btn-secondary btn-sm" @click="clearHistory()">
          <span>🗑️</span>
          <span data-i18n="clear">クリア</span>
        </button>
      </div>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
        <input 
          type="text" 
          class="form-input" 
          placeholder="サイト名やエラーメッセージで検索..." 
          x-model="searchQuery"
          data-i18n-placeholder="searchHistory"
        >
      </div>
      
      <div class="filter-chips">
        <button 
          class="filter-chip"
          :class="{ 'active': statusFilter === 'all' }"
          @click="statusFilter = 'all'"
          data-i18n="all"
        >
          全て
        </button>
        <button 
          class="filter-chip"
          :class="{ 'active': statusFilter === 'success' }"
          @click="statusFilter = 'success'"
          data-i18n="success"
        >
          成功
        </button>
        <button 
          class="filter-chip"
          :class="{ 'active': statusFilter === 'error' }"
          @click="statusFilter = 'error'"
          data-i18n="error"
        >
          失敗
        </button>
        <button 
          class="filter-chip"
          :class="{ 'active': statusFilter === 'running' }"
          @click="statusFilter = 'running'"
          data-i18n="running"
        >
          実行中
        </button>
      </div>
      
      <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
        <select class="form-select" x-model="websiteFilter">
          <option value="" data-i18n="allWebsites">全サイト</option>
          <template x-for="website in websites" :key="website.id">
            <option :value="website.id" x-text="website.name"></option>
          </template>
        </select>
      </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
      
      <!-- Loading State -->
      <div x-show="isLoading" class="flex items-center justify-center py-12">
        <div class="text-center">
          <div class="text-4xl mb-4">⏳</div>
          <div class="text-body" data-i18n="loading">読み込み中...</div>
        </div>
      </div>

      <!-- Empty State -->
      <div x-show="!isLoading && filteredHistory.length === 0" class="flex items-center justify-center py-12">
        <div class="text-center">
          <div class="text-6xl mb-4">📋</div>
          <div class="text-title mb-2" data-i18n="noHistoryFound">実行履歴がありません</div>
          <div class="text-caption">自動入力を実行すると、ここに履歴が表示されます</div>
        </div>
      </div>

      <!-- History Cards -->
      <div x-show="!isLoading && filteredHistory.length > 0" class="p-4 space-y-4">
        <template x-for="history in paginatedHistory" :key="history.id">
          <div class="history-card">
            
            <!-- Card Header -->
            <div class="history-card-header">
              <div class="flex items-center gap-3">
                <div 
                  class="execution-status"
                  :class="history.status"
                >
                  <span x-text="getStatusIcon(history.status)"></span>
                  <span class="text-title" x-text="history.websiteName"></span>
                  <span class="text-caption" x-text="getStatusText(history.status)"></span>
                </div>
              </div>
              <div class="text-caption" x-text="formatDate(history.executedAt)"></div>
            </div>

            <!-- Card Body -->
            <div class="history-card-body">
              <div class="mb-3">
                <div class="progress-bar">
                  <div 
                    class="progress-fill"
                    :class="history.status"
                    :style="`width: ${history.progress}%`"
                  ></div>
                </div>
                <div class="flex justify-between items-center mt-2 text-caption">
                  <span>
                    <span data-i18n="steps">ステップ:</span>
                    <span x-text="`${history.completedSteps}/${history.totalSteps}`"></span>
                  </span>
                  <span>
                    <span data-i18n="executionTime">実行時間:</span>
                    <span x-text="history.executionTime"></span>
                  </span>
                </div>
              </div>
              
              <!-- Error Message -->
              <div x-show="history.status === 'error' && history.errorMessage" class="mb-3">
                <div class="text-caption mb-1" data-i18n="errorMessage">エラーメッセージ:</div>
                <div class="text-body p-3 rounded" style="background: rgba(229, 57, 53, 0.1); color: var(--color-error);">
                  <span x-text="history.errorMessage"></span>
                </div>
              </div>
              
              <!-- Variables -->
              <div x-show="history.variables && Object.keys(history.variables).length > 0" class="mb-3">
                <div class="text-caption mb-2" data-i18n="variables">使用変数:</div>
                <div class="flex flex-wrap gap-2">
                  <template x-for="(value, key) in history.variables" :key="key">
                    <span class="status-badge status-info" x-text="`${key}: ${value}`"></span>
                  </template>
                </div>
              </div>
            </div>

            <!-- Card Footer -->
            <div class="history-card-footer">
              <div class="flex gap-2">
                <button 
                  class="btn btn-secondary btn-sm"
                  @click="viewDetails(history)"
                  data-i18n="viewDetails"
                >
                  <span>📄</span>
                  <span>詳細</span>
                </button>
                <button 
                  x-show="history.hasRecording"
                  class="btn btn-secondary btn-sm"
                  @click="viewRecording(history)"
                  data-i18n="viewRecording"
                >
                  <span>📹</span>
                  <span>録画</span>
                </button>
                <button 
                  class="btn btn-primary btn-sm"
                  @click="reExecute(history)"
                  data-i18n="reExecute"
                >
                  <span>🔄</span>
                  <span>再実行</span>
                </button>
              </div>
              <div class="text-caption">
                <span>ID:</span>
                <span x-text="history.id.substring(0, 8)"></span>
              </div>
            </div>
          </div>
        </template>
      </div>
    </main>

    <!-- Pagination -->
    <div x-show="!isLoading && totalPages > 1" class="pagination">
      <button 
        class="pagination-button"
        @click="currentPage = Math.max(1, currentPage - 1)"
        :disabled="currentPage === 1"
      >
        ◀️
      </button>
      
      <template x-for="page in visiblePages" :key="page">
        <button 
          class="pagination-button"
          :class="{ 'active': page === currentPage }"
          @click="currentPage = page"
          x-text="page"
        ></button>
      </template>
      
      <button 
        class="pagination-button"
        @click="currentPage = Math.min(totalPages, currentPage + 1)"
        :disabled="currentPage === totalPages"
      >
        ▶️
      </button>
    </div>

    <!-- Details Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showDetailsModal }"
      @click.self="showDetailsModal = false"
    >
      <div class="modal" style="width: 600px; max-width: 90vw;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="executionDetails">実行詳細</h2>
          <button class="modal-close" @click="showDetailsModal = false">✕</button>
        </div>
        <div class="modal-body" x-show="selectedHistory">
          <div class="space-y-4">
            <div>
              <div class="text-label mb-2" data-i18n="basicInfo">基本情報</div>
              <div class="card">
                <div class="card-body space-y-2">
                  <div class="flex justify-between">
                    <span class="text-caption">サイト名:</span>
                    <span x-text="selectedHistory?.websiteName"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-caption">実行日時:</span>
                    <span x-text="formatDate(selectedHistory?.executedAt)"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-caption">ステータス:</span>
                    <span 
                      class="status-badge"
                      :class="`status-${selectedHistory?.status === 'success' ? 'success' : selectedHistory?.status === 'error' ? 'error' : 'info'}`"
                      x-text="getStatusText(selectedHistory?.status)"
                    ></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-caption">実行時間:</span>
                    <span x-text="selectedHistory?.executionTime"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <div x-show="selectedHistory?.errorMessage">
              <div class="text-label mb-2" data-i18n="errorDetails">エラー詳細</div>
              <div class="card">
                <div class="card-body">
                  <pre class="text-body whitespace-pre-wrap" x-text="selectedHistory?.errorMessage"></pre>
                </div>
              </div>
            </div>
            
            <div x-show="selectedHistory?.variables">
              <div class="text-label mb-2" data-i18n="usedVariables">使用変数</div>
              <div class="card">
                <div class="card-body">
                  <template x-for="(value, key) in selectedHistory?.variables" :key="key">
                    <div class="flex justify-between py-1">
                      <span class="text-caption" x-text="key"></span>
                      <span x-text="value"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="showDetailsModal = false">
            <span data-i18n="close">閉じる</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Recording Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showRecordingModal }"
      @click.self="showRecordingModal = false"
    >
      <div class="modal" style="width: 800px; max-width: 95vw;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="executionRecording">実行録画</h2>
          <button class="modal-close" @click="showRecordingModal = false">✕</button>
        </div>
        <div class="modal-body text-center">
          <div class="text-6xl mb-4">📹</div>
          <div class="text-title mb-4">録画視聴機能</div>
          <div class="text-body mb-6">実行中の画面録画をここで視聴できます</div>
          <video 
            controls 
            style="width: 100%; max-height: 400px; border-radius: var(--radius-md);"
            poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999'%3E録画データ%3C/text%3E%3C/svg%3E"
          >
            <source src="#" type="video/webm">
            お使いのブラウザは動画の再生に対応していません。
          </video>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="showRecordingModal = false">
            <span data-i18n="close">閉じる</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Theme detection
    function detectTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Initial theme detection
    detectTheme();
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

    function executionHistoryApp() {
      return {
        history: [],
        websites: [],
        searchQuery: '',
        statusFilter: 'all',
        websiteFilter: '',
        currentPage: 1,
        itemsPerPage: 10,
        isLoading: true,
        showDetailsModal: false,
        showRecordingModal: false,
        selectedHistory: null,

        get filteredHistory() {
          let filtered = this.history;

          // Search filter
          if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            filtered = filtered.filter(h => 
              h.websiteName.toLowerCase().includes(query) ||
              (h.errorMessage && h.errorMessage.toLowerCase().includes(query))
            );
          }

          // Status filter
          if (this.statusFilter !== 'all') {
            filtered = filtered.filter(h => h.status === this.statusFilter);
          }

          // Website filter
          if (this.websiteFilter) {
            filtered = filtered.filter(h => h.websiteId === this.websiteFilter);
          }

          return filtered.sort((a, b) => new Date(b.executedAt) - new Date(a.executedAt));
        },

        get paginatedHistory() {
          const start = (this.currentPage - 1) * this.itemsPerPage;
          const end = start + this.itemsPerPage;
          return this.filteredHistory.slice(start, end);
        },

        get totalPages() {
          return Math.ceil(this.filteredHistory.length / this.itemsPerPage);
        },

        get visiblePages() {
          const pages = [];
          const start = Math.max(1, this.currentPage - 2);
          const end = Math.min(this.totalPages, this.currentPage + 2);
          
          for (let i = start; i <= end; i++) {
            pages.push(i);
          }
          
          return pages;
        },

        init() {
          this.loadHistory();
          this.loadWebsites();
        },

        async loadHistory() {
          this.isLoading = true;
          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 800));
            this.history = [
              {
                id: '1',
                websiteId: '1',
                websiteName: 'ログインサイト',
                status: 'success',
                progress: 100,
                completedSteps: 10,
                totalSteps: 10,
                executionTime: '45秒',
                executedAt: new Date(Date.now() - 1000 * 60 * 30).toISOString(),
                hasRecording: true,
                variables: { username: 'testuser', password: '***' }
              },
              {
                id: '2',
                websiteId: '2',
                websiteName: 'フォームサイト',
                status: 'error',
                progress: 60,
                completedSteps: 6,
                totalSteps: 10,
                executionTime: '23秒',
                executedAt: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
                hasRecording: false,
                errorMessage: 'ステップ7でタイムアウトが発生しました。要素が見つかりません: //*[@id="submit-btn"]',
                variables: { email: 'test@example.com' }
              },
              {
                id: '3',
                websiteId: '1',
                websiteName: 'ログインサイト',
                status: 'running',
                progress: 30,
                completedSteps: 3,
                totalSteps: 10,
                executionTime: '12秒',
                executedAt: new Date(Date.now() - 1000 * 60 * 5).toISOString(),
                hasRecording: true,
                variables: { username: 'testuser2' }
              }
            ];
          } catch (error) {
            console.error('Failed to load history:', error);
          } finally {
            this.isLoading = false;
          }
        },

        async loadWebsites() {
          try {
            this.websites = [
              { id: '1', name: 'ログインサイト' },
              { id: '2', name: 'フォームサイト' },
              { id: '3', name: 'テストサイト' }
            ];
          } catch (error) {
            console.error('Failed to load websites:', error);
          }
        },

        getStatusIcon(status) {
          const icons = {
            'success': '✅',
            'error': '❌',
            'running': '⚡'
          };
          return icons[status] || '❓';
        },

        getStatusText(status) {
          const texts = {
            'success': '成功',
            'error': '失敗',
            'running': '実行中'
          };
          return texts[status] || status;
        },

        formatDate(dateString) {
          return new Date(dateString).toLocaleString('ja-JP');
        },

        viewDetails(history) {
          this.selectedHistory = history;
          this.showDetailsModal = true;
        },

        viewRecording(history) {
          this.selectedHistory = history;
          this.showRecordingModal = true;
        },

        reExecute(history) {
          if (confirm(`「${history.websiteName}」を再実行しますか？`)) {
            console.log('Re-execute:', history);
          }
        },

        refreshHistory() {
          this.loadHistory();
        },

        clearHistory() {
          if (confirm('すべての実行履歴を削除しますか？この操作は取り消せません。')) {
            this.history = [];
          }
        }
      };
    }
  </script>
</body>
</html>
