<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>実行履歴</title>
  <link rel="stylesheet" href="styles/tailwind.css">
  <link rel="stylesheet" href="styles/unified-nav-bar.css">
  <link rel="stylesheet" href="styles/automation-variables.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Unified Navigation Bar -->
  <div id="unifiedNavBar"></div>

  <!-- Filter Bar (50px) -->
  <div class="filter-bar">
    <!-- Search Box -->
    <div class="search-box">
      <span class="search-icon">🔍</span>
      <input type="text" class="search-input" id="searchInput" placeholder="検索..." data-i18n-placeholder="search">
    </div>

    <!-- Status Filters -->
    <div class="filter-group">
      <button class="btn-sm btn-secondary active" id="filterAll" data-i18n="all">全て</button>
      <button class="btn-sm btn-secondary" id="filterSuccess" data-i18n="success">成功</button>
      <button class="btn-sm btn-secondary" id="filterFailed" data-i18n="failed">失敗</button>
    </div>

    <!-- Date Range -->
    <div class="filter-group">
      <label class="filter-label" data-i18n="dateRange">📅 日付範囲:</label>
      <input type="date" class="form-input w-36" id="dateFrom">
      <span class="text-sm text-gray-600">-</span>
      <input type="date" class="form-input w-36" id="dateTo">
    </div>

    <!-- Site Filter -->
    <div class="filter-group">
      <label class="filter-label" data-i18n="site">サイト:</label>
      <select class="form-input w-48" id="siteFilter">
        <option value="" data-i18n="allSites">全サイト</option>
      </select>
    </div>
  </div>

  <!-- History Cards Container -->
  <div class="max-w-screen-xl mx-auto px-4 py-6">
    <div id="historyList" class="space-y-3">
      <!-- Sample History Card 1 (Success) -->
      <div class="history-card">
        <div class="history-card-header">
          <div class="history-card-title">
            <span class="status-success">✅</span>
            <span>サンプルサイト - 成功</span>
          </div>
          <div class="history-card-meta">2025-01-18 10:30</div>
        </div>
        <div class="history-card-body">
          <div>ステップ数: 10/10 | 実行時間: 45秒</div>
        </div>
        <div class="history-card-actions">
          <button class="btn-info btn-sm" data-action="recording">📹 録画</button>
          <button class="btn-info btn-sm" data-action="detail">📄 詳細</button>
          <button class="btn-success btn-sm" data-action="retry">🔄 再実行</button>
        </div>
      </div>

      <!-- Sample History Card 2 (Failed) -->
      <div class="history-card">
        <div class="history-card-header">
          <div class="history-card-title">
            <span class="status-failed">❌</span>
            <span>サンプルサイト2 - 失敗</span>
          </div>
          <div class="history-card-meta">2025-01-18 09:15</div>
        </div>
        <div class="history-card-body">
          <div>エラー: ステップ5でタイムアウト</div>
          <div>ステップ数: 5/10 | 実行時間: 120秒</div>
        </div>
        <div class="history-card-actions">
          <button class="btn-info btn-sm" data-action="detail">📄 詳細</button>
          <button class="btn-success btn-sm" data-action="retry">🔄 再実行</button>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state hidden" id="emptyState" data-i18n="noExecutionHistory">実行履歴がありません</div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button class="pagination-button" id="prevPageBtn" disabled>◀️</button>
      <span class="pagination-info">📄 ページ: <span id="currentPage">1</span> / <span id="totalPages">5</span></span>
      <button class="pagination-button" id="nextPageBtn">▶️</button>
    </div>
  </div>

  <!-- Edit/Create Modal (for backward compatibility with existing JS) -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle" data-i18n="editAutomationVariables">Automation Variables を編集</div>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editId">

        <!-- Website Selection -->
        <div class="form-group">
          <label for="editWebsiteId" class="form-label" data-i18n="selectWebsite">サイト選択</label>
          <select id="editWebsiteId" class="form-input" required>
            <option value="" data-i18n="selectWebsitePlaceholder">サイトを選択してください</option>
          </select>
        </div>

        <!-- Status Selection -->
        <div class="form-group">
          <label for="editStatus" class="form-label" data-i18n="status">ステータス</label>
          <select id="editStatus" class="form-input" required>
            <option value="disabled" data-i18n="statusDisabled">無効</option>
            <option value="enabled" data-i18n="statusEnabled">有効</option>
            <option value="once" data-i18n="statusOnce">一度だけ</option>
          </select>
        </div>

        <!-- Variable Fields -->
        <div class="border-t border-gray-200 pt-4 mt-4">
          <label class="form-label mb-3" data-i18n="variablesList">変数一覧</label>
          <div id="variableFieldsContainer" class="space-y-2 mb-3"></div>
          <button type="button" class="btn-success w-full" id="addVariableFieldBtn" data-i18n="addNewVariable">➕ 新しい変数を追加</button>
        </div>

        <!-- Actions -->
        <div class="modal-actions justify-end">
          <button type="submit" class="btn-success" data-i18n="save">💾 保存</button>
          <button type="button" class="btn-secondary" id="cancelBtn" data-i18n="cancel">✖ キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recording Modal -->
  <div class="modal-overlay" id="recordingModal">
    <div class="modal-content max-w-4xl">
      <div class="modal-header">
        <span data-i18n="recording">🎥 録画</span>
        <button class="close-recording-modal absolute right-4 top-4 text-2xl text-gray-500 hover:text-gray-700">✖</button>
      </div>
      <div class="space-y-4">
        <video id="recordingVideo" controls width="100%" class="rounded-lg">
          <source src="" type="video/webm">
          <span data-i18n="videoNotSupported">ご使用のブラウザは動画再生に対応していません。</span>
        </video>
        <div class="grid grid-cols-3 gap-4 text-sm">
          <div>
            <span class="font-semibold" data-i18n="duration">再生時間:</span>
            <span id="videoDuration">--</span><span data-i18n="seconds">秒</span>
          </div>
          <div>
            <span class="font-semibold" data-i18n="fileSize">ファイルサイズ:</span>
            <span id="videoFileSize">--</span>MB
          </div>
          <div>
            <span class="font-semibold" data-i18n="bitrate">ビットレート:</span>
            <span id="videoBitrate">--</span>Mbps
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary close-recording-modal" data-i18n="close">✖ 閉じる</button>
      </div>
    </div>
  </div>

  <!-- Navigation Bar Templates -->
  <template id="unified-nav-bar-template">
    <nav class="unified-nav-bar">
      <div class="nav-content">
        <!-- Title Section -->
        <h1 class="nav-title" id="navTitle">📋 実行履歴</h1>

        <!-- Actions Section -->
        <div class="nav-actions">
          <!-- Export Dropdown -->
          <div class="dropdown-container">
            <button class="btn-export" id="exportDropdownBtn">
              <span class="btn-icon">📤</span>
              <span class="btn-text" data-i18n="export">エクスポート</span>
              <span class="dropdown-arrow">▼</span>
            </button>

            <div class="dropdown-menu" id="exportDropdownMenu">
              <div class="dropdown-section">
                <div class="dropdown-section-title" data-i18n="exportDataTypes">データタイプ</div>
                <div id="exportMenuItems"></div>
              </div>
            </div>
          </div>

          <!-- Import Button -->
          <button class="btn-import" id="importBtn">
            <span class="btn-icon">📥</span>
            <span class="btn-text" data-i18n="import">インポート</span>
          </button>

          <!-- Back Button -->
          <a href="popup.html" class="btn-back" id="backToMainBtn">
            <span class="btn-icon">←</span>
            <span class="btn-text" data-i18n="back">戻る</span>
          </a>
        </div>
      </div>
    </nav>
  </template>

  <!-- Export Menu Item Template -->
  <template id="export-menu-item-template">
    <button class="export-menu-item" data-export="">
      <span class="menu-icon"></span>
      <div class="menu-content">
        <span class="menu-label"></span>
        <span class="menu-description"></span>
      </div>
    </button>
  </template>

  <!-- Automation Variables Templates (for backward compatibility) -->
  <template id="automation-variables-item-template">
    <div class="variables-item" data-bind-attr="id:data-id">
      <div class="variables-header">
        <div class="variables-website" data-bind="websiteName"></div>
        <div class="variables-actions">
          <button class="btn-info" data-action="preview-recording" data-bind-attr="id:data-id" data-i18n="previewRecording">🎥 録画を見る</button>
          <button class="btn-warning" data-action="edit" data-bind-attr="id:data-id" data-i18n="edit">編集</button>
          <button class="btn-info" data-action="duplicate" data-bind-attr="id:data-id" data-i18n="duplicate">複製</button>
          <button class="btn-danger" data-action="delete" data-bind-attr="id:data-id" data-i18n="delete">削除</button>
        </div>
      </div>
      <div class="variables-info">
        <span class="variables-status" data-bind-attr="statusClass:class" data-bind="statusLabel"></span>
        <span><span data-bind="updatedAtLabel"></span> <span data-bind="updatedAt"></span></span>
      </div>
      <div class="variables-data">
        <span class="variables-data-label" data-bind="variablesLabel"></span>
        <span data-bind="variablesFormatted"></span>
      </div>
      <div class="variables-data" data-bind-if="hasLatestResult">
        <span class="variables-data-label" data-bind="latestExecutionLabel"></span>
        <span data-bind-attr="resultStatusClass:class" data-bind="resultStatusLabel"></span>
        <span data-bind-if="hasResultDetail"> - <span data-bind="resultDetail"></span></span>
        (<span data-bind="resultStartFrom"></span>)
      </div>
    </div>
  </template>

  <template id="automation-variables-loading-state-template">
    <div class="loading-state" data-i18n="loading" data-bind="loadingText"></div>
  </template>

  <template id="automation-variables-empty-state-template">
    <div class="empty-state" data-i18n="noAutomationVariables" data-bind="emptyText"></div>
  </template>

  <template id="automation-variables-recording-modal-template">
    <div class="recording-modal-content">
      <div class="recording-modal-header">
        <h3 data-bind="headerText"></h3>
        <button class="close-recording-modal">✖</button>
      </div>
      <div class="recording-modal-body">
        <video id="recordingVideo" controls width="100%">
          <source src="" data-bind-attr="mimeType:type">
          <span data-bind="videoNotSupported"></span>
        </video>
        <div class="recording-info">
          <p><span data-bind="durationLabel"></span> <span data-bind="duration"></span><span data-bind="secondsUnit"></span></p>
          <p><span data-bind="fileSizeLabel"></span> <span data-bind="fileSize"></span>MB</p>
          <p><span data-bind="bitrateLabel"></span> <span data-bind="bitrate"></span>Mbps</p>
        </div>
      </div>
    </div>
  </template>

  <script src="automation-variables-manager.js"></script>
</body>
</html>
