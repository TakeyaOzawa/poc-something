<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="xpathManager">XPath管理</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* XPath Manager Specific Styles */
    .xpath-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-1);
    }
    
    .xpath-table th {
      background: var(--color-surface-variant);
      padding: var(--spacing-4);
      text-align: left;
      font-weight: 600;
      color: var(--color-on-surface);
      border-bottom: 1px solid var(--color-outline-variant);
    }
    
    .xpath-table td {
      padding: var(--spacing-4);
      border-bottom: 1px solid var(--color-outline-variant);
      vertical-align: top;
    }
    
    .xpath-table tbody tr:hover {
      background: var(--color-surface-variant);
    }
    
    .xpath-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .xpath-value {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .xpath-path {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: monospace;
      font-size: 12px;
      background: var(--color-surface-variant);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
    }
    
    .action-type-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-1);
      padding: var(--spacing-1) var(--spacing-2);
      font-size: var(--font-size-xs);
      font-weight: 500;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
    }
    
    .action-type-input { background: rgba(67, 160, 71, 0.1); color: var(--color-success); }
    .action-type-click { background: rgba(30, 136, 229, 0.1); color: var(--color-info); }
    .action-type-change-url { background: rgba(251, 140, 0, 0.1); color: var(--color-warning); }
    .action-type-check { background: rgba(229, 57, 53, 0.1); color: var(--color-error); }
    
    .toolbar {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-4);
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-outline-variant);
      flex-wrap: wrap;
    }
    
    .stats-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-4);
      background: var(--color-surface-variant);
      border-top: 1px solid var(--color-outline-variant);
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
    }
  </style>
</head>
<body style="background: var(--color-background); min-height: 100vh;">
  <div x-data="xpathManagerApp()" class="min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="nav-header">
      <div class="flex items-center gap-3">
        <a href="popup.html" class="nav-back">
          <span>←</span>
          <span data-i18n="back">戻る</span>
        </a>
        <div class="nav-title">
          <span>🔍</span>
          <span data-i18n="xpathManager">XPath管理</span>
          <span x-show="selectedWebsite" class="text-caption" x-text="`- ${selectedWebsite?.name}`"></span>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn btn-secondary btn-sm" @click="refreshData()">
          <span>🔄</span>
          <span data-i18n="refresh">更新</span>
        </button>
        <button class="btn btn-secondary btn-sm" @click="importXPaths()">
          <span>📥</span>
          <span data-i18n="import">インポート</span>
        </button>
        <button class="btn btn-secondary btn-sm" @click="exportXPaths()">
          <span>📤</span>
          <span data-i18n="export">エクスポート</span>
        </button>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
        <select class="form-select" x-model="selectedWebsiteId" @change="loadXPaths()">
          <option value="" data-i18n="selectWebsite">サイトを選択...</option>
          <template x-for="website in websites" :key="website.id">
            <option :value="website.id" x-text="website.name"></option>
          </template>
        </select>
      </div>
      
      <button class="btn btn-primary" @click="addXPath()" :disabled="!selectedWebsiteId">
        <span>➕</span>
        <span data-i18n="addStep">ステップ追加</span>
      </button>
      
      <div class="flex gap-2">
        <button class="btn btn-success" @click="executeXPaths()" :disabled="!selectedWebsiteId || xpaths.length === 0">
          <span>▶️</span>
          <span data-i18n="execute">実行</span>
        </button>
        <button class="btn btn-danger" @click="stopExecution()" x-show="isExecuting">
          <span>⏸️</span>
          <span data-i18n="stop">停止</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
      
      <!-- Empty State -->
      <div x-show="!selectedWebsiteId" class="flex items-center justify-center h-full">
        <div class="text-center py-12">
          <div class="text-6xl mb-4">🔍</div>
          <div class="text-title mb-2" data-i18n="selectWebsiteFirst">サイトを選択してください</div>
          <div class="text-caption">上部のドロップダウンからサイトを選択すると、XPathステップを管理できます</div>
        </div>
      </div>

      <!-- XPath Table -->
      <div x-show="selectedWebsiteId" class="h-full flex flex-col">
        
        <!-- Loading State -->
        <div x-show="isLoading" class="flex items-center justify-center py-12">
          <div class="text-center">
            <div class="text-4xl mb-4">⏳</div>
            <div class="text-body" data-i18n="loading">読み込み中...</div>
          </div>
        </div>

        <!-- Table Container -->
        <div x-show="!isLoading" class="flex-1 overflow-auto p-4">
          
          <!-- No XPaths State -->
          <div x-show="xpaths.length === 0" class="text-center py-12">
            <div class="text-6xl mb-4">📝</div>
            <div class="text-title mb-2" data-i18n="noXPathsFound">XPathステップが登録されていません</div>
            <div class="text-caption mb-6">「ステップ追加」ボタンから自動入力ステップを追加してください</div>
            <button class="btn btn-primary" @click="addXPath()">
              <span>➕</span>
              <span data-i18n="addStep">ステップ追加</span>
            </button>
          </div>

          <!-- XPath Table -->
          <table x-show="xpaths.length > 0" class="xpath-table">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th style="width: 100px;" data-i18n="actionType">種別</th>
                <th style="width: 200px;" data-i18n="value">値</th>
                <th data-i18n="xpath">XPath</th>
                <th style="width: 120px;" data-i18n="actions">操作</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(xpath, index) in sortedXPaths" :key="xpath.id">
                <tr>
                  <td class="text-center text-caption" x-text="xpath.executionOrder"></td>
                  <td>
                    <span 
                      class="action-type-badge"
                      :class="`action-type-${xpath.actionType.toLowerCase().replace('_', '-')}`"
                      x-text="getActionTypeText(xpath.actionType)"
                    ></span>
                  </td>
                  <td>
                    <div class="xpath-value" :title="xpath.value" x-text="xpath.value || '-'"></div>
                  </td>
                  <td>
                    <div class="xpath-path" :title="getSelectedXPath(xpath)" x-text="getSelectedXPath(xpath)"></div>
                  </td>
                  <td>
                    <div class="flex gap-1">
                      <button class="btn btn-secondary btn-sm" @click="editXPath(xpath)" :title="'編集'">
                        <span>✏️</span>
                      </button>
                      <button class="btn btn-secondary btn-sm" @click="duplicateXPath(xpath)" :title="'複製'">
                        <span>📋</span>
                      </button>
                      <button class="btn btn-danger btn-sm" @click="deleteXPath(xpath)" :title="'削除'">
                        <span>🗑️</span>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Stats Bar -->
        <div x-show="!isLoading && selectedWebsiteId" class="stats-bar">
          <div class="flex items-center gap-6">
            <span>
              <span>📊</span>
              <span data-i18n="stepCount">ステップ数:</span>
              <strong x-text="xpaths.length"></strong>
            </span>
            <span>
              <span>⏱️</span>
              <span data-i18n="estimatedTime">推定実行時間:</span>
              <strong x-text="estimatedExecutionTime"></strong>
            </span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-caption">最終更新:</span>
            <span class="text-caption" x-text="lastUpdated"></span>
          </div>
        </div>

      </div>
    </main>

    <!-- Add/Edit XPath Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showXPathModal }"
      @click.self="showXPathModal = false"
    >
      <div class="modal" style="width: 600px; max-width: 90vw;">
        <div class="modal-header">
          <h2 class="modal-title" x-text="editingXPath ? 'XPathステップ編集' : 'XPathステップ追加'"></h2>
          <button class="modal-close" @click="showXPathModal = false">✕</button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveXPath()">
            <div class="space-y-4">
              
              <div class="form-group">
                <label class="form-label" data-i18n="actionType">アクション種別</label>
                <select class="form-select" x-model="xpathForm.actionType" required>
                  <option value="INPUT">INPUT - テキスト入力</option>
                  <option value="CLICK">CLICK - クリック</option>
                  <option value="CHANGE_URL">CHANGE_URL - URL変更</option>
                  <option value="CHECK">CHECK - 条件チェック</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" data-i18n="value">値</label>
                <input 
                  type="text" 
                  class="form-input" 
                  x-model="xpathForm.value"
                  placeholder="例: {{username}} または 固定値"
                >
                <div class="text-caption mt-1">変数を使用する場合は {{変数名}} の形式で入力してください</div>
              </div>

              <div class="form-group">
                <label class="form-label" data-i18n="executionOrder">実行順序</label>
                <input 
                  type="number" 
                  class="form-input" 
                  x-model="xpathForm.executionOrder"
                  min="1"
                  required
                >
              </div>

              <div class="form-group">
                <label class="form-label" data-i18n="url">対象URL</label>
                <input 
                  type="text" 
                  class="form-input" 
                  x-model="xpathForm.url"
                  placeholder="https://example.com/page または正規表現"
                  required
                >
              </div>

              <div class="form-group">
                <label class="form-label" data-i18n="xpath">XPath</label>
                <textarea 
                  class="form-input" 
                  x-model="xpathForm.xpath"
                  rows="3"
                  placeholder="//*[@id='username'] または //input[@name='username']"
                  required
                ></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" data-i18n="afterWait">実行後待機時間（秒）</label>
                  <input 
                    type="number" 
                    class="form-input" 
                    x-model="xpathForm.afterWaitSeconds"
                    min="0"
                    step="0.1"
                  >
                </div>
                <div class="form-group">
                  <label class="form-label" data-i18n="timeout">タイムアウト（秒）</label>
                  <input 
                    type="number" 
                    class="form-input" 
                    x-model="xpathForm.executionTimeoutSeconds"
                    min="1"
                  >
                </div>
              </div>

            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="showXPathModal = false">
            <span data-i18n="cancel">キャンセル</span>
          </button>
          <button class="btn btn-primary" @click="saveXPath()">
            <span x-text="editingXPath ? '💾 更新' : '➕ 追加'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Execution Progress Modal -->
    <div 
      class="modal-overlay"
      :class="{ 'active': showExecutionModal }"
    >
      <div class="modal" style="width: 480px;">
        <div class="modal-header">
          <h2 class="modal-title" data-i18n="executionProgress">実行中</h2>
        </div>
        <div class="modal-body text-center">
          <div class="text-6xl mb-4">⚡</div>
          <div class="text-title mb-2" x-text="executionStatus.siteName"></div>
          <div class="text-body mb-4" x-text="executionStatus.message"></div>
          
          <!-- Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div 
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              :style="`width: ${executionStatus.progress}%`"
            ></div>
          </div>
          
          <div class="text-caption" x-text="`${executionStatus.currentStep} / ${executionStatus.totalSteps} ステップ`"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" @click="stopExecution()">
            <span>⏸️</span>
            <span data-i18n="stop">停止</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Theme detection
    function detectTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Initial theme detection
    detectTheme();
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

    function xpathManagerApp() {
      return {
        websites: [],
        xpaths: [],
        selectedWebsiteId: '',
        selectedWebsite: null,
        isLoading: false,
        isExecuting: false,
        showXPathModal: false,
        showExecutionModal: false,
        editingXPath: null,
        xpathForm: {
          actionType: 'INPUT',
          value: '',
          executionOrder: 1,
          url: '',
          xpath: '',
          afterWaitSeconds: 0,
          executionTimeoutSeconds: 30
        },
        executionStatus: {
          siteName: '',
          message: '',
          progress: 0,
          currentStep: 0,
          totalSteps: 0
        },

        get sortedXPaths() {
          return [...this.xpaths].sort((a, b) => a.executionOrder - b.executionOrder);
        },

        get estimatedExecutionTime() {
          const totalWait = this.xpaths.reduce((sum, xpath) => sum + (xpath.afterWaitSeconds || 0), 0);
          const totalTimeout = this.xpaths.reduce((sum, xpath) => sum + (xpath.executionTimeoutSeconds || 30), 0);
          const estimated = Math.ceil((totalWait + totalTimeout * 0.1) / this.xpaths.length * this.xpaths.length);
          return `${estimated}秒`;
        },

        get lastUpdated() {
          return new Date().toLocaleString('ja-JP');
        },

        init() {
          this.loadWebsites();
        },

        async loadWebsites() {
          this.isLoading = true;
          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 300));
            this.websites = [
              { id: '1', name: 'ログインサイト' },
              { id: '2', name: 'フォームサイト' },
              { id: '3', name: 'テストサイト' }
            ];
          } catch (error) {
            console.error('Failed to load websites:', error);
          } finally {
            this.isLoading = false;
          }
        },

        async loadXPaths() {
          if (!this.selectedWebsiteId) {
            this.xpaths = [];
            this.selectedWebsite = null;
            return;
          }

          this.isLoading = true;
          this.selectedWebsite = this.websites.find(w => w.id === this.selectedWebsiteId);
          
          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            this.xpaths = [
              {
                id: '1',
                actionType: 'INPUT',
                value: '{{username}}',
                executionOrder: 1,
                url: 'https://example.com/login',
                xpath: '//*[@id="username"]',
                afterWaitSeconds: 1,
                executionTimeoutSeconds: 30
              },
              {
                id: '2',
                actionType: 'INPUT',
                value: '{{password}}',
                executionOrder: 2,
                url: 'https://example.com/login',
                xpath: '//*[@id="password"]',
                afterWaitSeconds: 1,
                executionTimeoutSeconds: 30
              },
              {
                id: '3',
                actionType: 'CLICK',
                value: '',
                executionOrder: 3,
                url: 'https://example.com/login',
                xpath: '//button[@type="submit"]',
                afterWaitSeconds: 2,
                executionTimeoutSeconds: 30
              }
            ];
          } catch (error) {
            console.error('Failed to load XPaths:', error);
          } finally {
            this.isLoading = false;
          }
        },

        getActionTypeText(actionType) {
          const types = {
            'INPUT': 'INPUT',
            'CLICK': 'CLICK',
            'CHANGE_URL': 'URL変更',
            'CHECK': 'チェック'
          };
          return types[actionType] || actionType;
        },

        getSelectedXPath(xpath) {
          return xpath.xpath || '-';
        },

        addXPath() {
          this.editingXPath = null;
          this.xpathForm = {
            actionType: 'INPUT',
            value: '',
            executionOrder: this.xpaths.length + 1,
            url: '',
            xpath: '',
            afterWaitSeconds: 0,
            executionTimeoutSeconds: 30
          };
          this.showXPathModal = true;
        },

        editXPath(xpath) {
          this.editingXPath = xpath;
          this.xpathForm = { ...xpath };
          this.showXPathModal = true;
        },

        duplicateXPath(xpath) {
          const duplicate = {
            ...xpath,
            id: Date.now().toString(),
            executionOrder: this.xpaths.length + 1
          };
          this.xpaths.push(duplicate);
        },

        deleteXPath(xpath) {
          if (confirm(`ステップ ${xpath.executionOrder} を削除しますか？`)) {
            this.xpaths = this.xpaths.filter(x => x.id !== xpath.id);
          }
        },

        saveXPath() {
          if (this.editingXPath) {
            // Update existing
            const index = this.xpaths.findIndex(x => x.id === this.editingXPath.id);
            if (index !== -1) {
              this.xpaths[index] = { ...this.xpathForm };
            }
          } else {
            // Add new
            const newXPath = {
              id: Date.now().toString(),
              ...this.xpathForm
            };
            this.xpaths.push(newXPath);
          }
          this.showXPathModal = false;
        },

        async executeXPaths() {
          if (!this.selectedWebsite || this.xpaths.length === 0) return;

          this.isExecuting = true;
          this.executionStatus = {
            siteName: this.selectedWebsite.name,
            message: '実行を開始しています...',
            progress: 0,
            currentStep: 0,
            totalSteps: this.xpaths.length
          };
          this.showExecutionModal = true;

          // Simulate execution progress
          for (let i = 1; i <= this.xpaths.length; i++) {
            if (!this.isExecuting) break; // Check if stopped
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            this.executionStatus.currentStep = i;
            this.executionStatus.progress = (i / this.xpaths.length) * 100;
            this.executionStatus.message = `ステップ ${i} を実行中...`;
          }

          if (this.isExecuting) {
            this.executionStatus.message = '実行が完了しました！';
            setTimeout(() => {
              this.showExecutionModal = false;
              this.isExecuting = false;
            }, 2000);
          }
        },

        stopExecution() {
          this.isExecuting = false;
          this.showExecutionModal = false;
        },

        refreshData() {
          this.loadXPaths();
        },

        importXPaths() {
          console.log('Import XPaths');
        },

        exportXPaths() {
          console.log('Export XPaths');
        }
      };
    }
  </script>
</body>
</html>
