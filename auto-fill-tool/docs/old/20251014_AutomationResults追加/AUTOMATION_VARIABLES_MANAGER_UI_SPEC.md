# AutomationVariables Manager - UI Specification

## 画面構成

### 1. メイン画面（一覧表示）

```
┌────────────────────────────────────────────────────────────────────┐
│ 🔤 Automation Variables 管理                                        │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐           ┌──────────┐  │
│  │➕新規作成│ │📤エクスポート│ │📥インポート│           │← 戻る  │  │
│  └──────────┘ └──────────┘ └──────────┘           └──────────┘  │
│                                                                    │
│  フィルター: [全サイト                      ▾]                      │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 📌 Example Site                                              │ │
│  │ ID: abc123-def456-ghi789                                     │ │
│  │ Website ID: website-001                                      │ │
│  │ Status: 🟢 Active                                            │ │
│  │ Variables: username, password, email (3 variables)           │ │
│  │ Updated: 2025-10-15 10:30:45                                │ │
│  │                                                              │ │
│  │ ⏱️ 最新の実行結果:                                           │ │
│  │ ┌────────────────────────────────────────────────────────┐ │ │
│  │ │ ✅ Success - 5.3秒                                     │ │ │
│  │ │ Successfully completed all 10 steps                    │ │ │
│  │ │ 開始: 2025-10-15 10:00:00                             │ │ │
│  │ │ 終了: 2025-10-15 10:00:05                             │ │ │
│  │ └────────────────────────────────────────────────────────┘ │ │
│  │                                   ┌─────┐┌─────┐┌─────┐     │ │
│  │                                   │✏️編集││🗑️削除││📋複製│     │ │
│  │                                   └─────┘└─────┘└─────┘     │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 📌 Another Site                                              │ │
│  │ ID: xyz987-uvw654-rst321                                     │ │
│  │ Website ID: website-002                                      │ │
│  │ Status: ⚠️ Test                                              │ │
│  │ Variables: api_key, token (2 variables)                      │ │
│  │ Updated: 2025-10-14 15:20:30                                │ │
│  │                                                              │ │
│  │ ⏱️ 最新の実行結果:                                           │ │
│  │ ┌────────────────────────────────────────────────────────┐ │ │
│  │ │ ❌ Failed - 2.1秒                                      │ │ │
│  │ │ Failed at step 5: Element not found                   │ │ │
│  │ │ 開始: 2025-10-14 15:30:00                             │ │ │
│  │ │ 終了: 2025-10-14 15:30:02                             │ │ │
│  │ └────────────────────────────────────────────────────────┘ │ │
│  │                                   ┌─────┐┌─────┐┌─────┐     │ │
│  │                                   │✏️編集││🗑️削除││📋複製│     │ │
│  │                                   └─────┘└─────┘└─────┘     │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 📌 Test Environment                                          │ │
│  │ ID: test123-test456-test789                                  │ │
│  │ Website ID: website-003                                      │ │
│  │ Status: ⭕ Inactive                                          │ │
│  │ Variables: none                                              │ │
│  │ Updated: 2025-10-10 09:00:00                                │ │
│  │                                                              │ │
│  │ ⏱️ 最新の実行結果:                                           │ │
│  │ ┌────────────────────────────────────────────────────────┐ │ │
│  │ │ 📭 実行履歴なし                                        │ │ │
│  │ └────────────────────────────────────────────────────────┘ │ │
│  │                                   ┌─────┐┌─────┐┌─────┐     │ │
│  │                                   │✏️編集││🗑️削除││📋複製│     │ │
│  │                                   └─────┘└─────┘└─────┘     │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 2. 新規作成/編集モーダル

```
        ┌──────────────────────────────────────────┐
        │ 🔤 Automation Variables を編集            │
        ├──────────────────────────────────────────┤
        │                                          │
        │  サイトを選択 *                          │
        │  ┌────────────────────────────────────┐ │
        │  │ Example Site                    ▾  │ │
        │  └────────────────────────────────────┘ │
        │                                          │
        │  ステータス                              │
        │  ◉ Active  ○ Inactive  ○ Test          │
        │                                          │
        │  ───────────────────────────────────    │
        │                                          │
        │  変数一覧                                │
        │  ┌────────────────────────────────────┐ │
        │  │ username                           │ │
        │  │ test@example.com                   │ │
        │  │                         [🗑️ 削除]  │ │
        │  ├────────────────────────────────────┤ │
        │  │ password                           │ │
        │  │ ********                           │ │
        │  │                         [🗑️ 削除]  │ │
        │  ├────────────────────────────────────┤ │
        │  │ email                              │ │
        │  │ user@example.com                   │ │
        │  │                         [🗑️ 削除]  │ │
        │  └────────────────────────────────────┘ │
        │                                          │
        │  新しい変数を追加                        │
        │  変数名: [________________]             │
        │  値:     [________________]             │
        │  ┌──────────┐                           │
        │  │➕ 追加   │                           │
        │  └──────────┘                           │
        │                                          │
        │  ───────────────────────────────────    │
        │                                          │
        │  ┌──────────┐  ┌──────────┐            │
        │  │💾 保存   │  │✖ キャンセル│            │
        │  └──────────┘  └──────────┘            │
        │                                          │
        └──────────────────────────────────────────┘
```

### 3. 削除確認ダイアログ

```
            ┌────────────────────────────────┐
            │ 🗑️ 削除の確認                  │
            ├────────────────────────────────┤
            │                                │
            │  以下のAutomation Variables    │
            │  を削除してもよろしいですか？  │
            │                                │
            │  サイト: Example Site          │
            │  変数数: 3                     │
            │                                │
            │  ⚠️ この操作は取り消せません    │
            │                                │
            │  ┌──────────┐  ┌──────────┐  │
            │  │🗑️ 削除   │  │✖ キャンセル│  │
            │  └──────────┘  └──────────┘  │
            │                                │
            └────────────────────────────────┘
```

### 4. インポート確認ダイアログ

```
        ┌──────────────────────────────────────────┐
        │ 📥 インポートの確認                       │
        ├──────────────────────────────────────────┤
        │                                          │
        │  以下のデータをインポートします:          │
        │                                          │
        │  ファイル名: automation_vars.csv         │
        │  件数: 5件                               │
        │                                          │
        │  ┌────────────────────────────────────┐ │
        │  │ • Example Site (3 variables)       │ │
        │  │ • Another Site (2 variables)       │ │
        │  │ • Test Site (1 variable)           │ │
        │  │ • Demo Site (4 variables)          │ │
        │  │ • Production Site (5 variables)    │ │
        │  └────────────────────────────────────┘ │
        │                                          │
        │  ⚠️ 既存のデータは上書きされます          │
        │                                          │
        │  ┌──────────┐  ┌──────────┐            │
        │  │📥 実行   │  │✖ キャンセル│            │
        │  └──────────┘  └──────────┘            │
        │                                          │
        └──────────────────────────────────────────┘
```

### 5. 空の状態（データなし）

```
┌────────────────────────────────────────────────────────────────────┐
│ 🔤 Automation Variables 管理                                        │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐           ┌──────────┐  │
│  │➕新規作成│ │📤エクスポート│ │📥インポート│           │← 戻る  │  │
│  └──────────┘ └──────────┘ └──────────┘           └──────────┘  │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│                         📭                                         │
│                                                                    │
│            Automation Variables が登録されていません                │
│                                                                    │
│          「新規作成」ボタンから追加してください                     │
│                                                                    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## ユーザーフロー

### フロー1: 新規作成

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ メイン  │────>│ 新規作成 │────>│ サイト   │────>│ 変数入力 │
│ 画面    │     │ ボタン   │     │ 選択     │     │          │
└─────────┘     └──────────┘     └──────────┘     └──────────┘
                                                         │
                                                         v
    ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ メイン  │<────│ 保存完了 │<────│ バリデー │<────│ 保存     │
    │ 画面    │     │ 通知     │     │ ション   │     │ ボタン   │
    └─────────┘     └──────────┘     └──────────┘     └──────────┘
```

### フロー2: 編集

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ メイン  │────>│ 編集     │────>│ モーダル │────>│ 変数     │
│ 画面    │     │ ボタン   │     │ 表示     │     │ 編集     │
└─────────┘     └──────────┘     └──────────┘     └──────────┘
                                                         │
                                                         v
    ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ メイン  │<────│ 更新完了 │<────│ バリデー │<────│ 保存     │
    │ 画面    │     │ 通知     │     │ ション   │     │ ボタン   │
    └─────────┘     └──────────┘     └──────────┘     └──────────┘
```

### フロー3: 削除

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ メイン  │────>│ 削除     │────>│ 確認     │────>│ 削除実行 │
│ 画面    │     │ ボタン   │     │ ダイアログ│     │ (Yes)    │
└─────────┘     └──────────┘     └──────────┘     └──────────┘
                                       │                 │
                                       │ (No)            v
                                       v           ┌──────────┐
                                  ┌─────────┐     │ 削除完了 │
                                  │ キャンセル│     │ 通知     │
                                  └─────────┘     └──────────┘
                                       │                 │
                                       v                 v
                                  ┌─────────────────────┐
                                  │ メイン画面          │
                                  └─────────────────────┘
```

### フロー4: インポート

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ メイン  │────>│ インポート│────>│ ファイル │────>│ CSV解析 │
│ 画面    │     │ ボタン   │     │ 選択     │     │          │
└─────────┘     └──────────┘     └──────────┘     └──────────┘
                                                         │
                                                         v
    ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ メイン  │<────│ 完了通知 │<────│ データ   │<────│ 確認     │
    │ 画面    │     │          │     │ 保存     │     │ ダイアログ│
    └─────────┘     └──────────┘     └──────────┘     └──────────┘
```

### フロー5: エクスポート

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ メイン  │────>│ エクスポート│────>│ CSV生成 │────>│ ダウンロード│
│ 画面    │     │ ボタン   │     │          │     │          │
└─────────┘     └──────────┘     └──────────┘     └──────────┘
                                                         │
                                                         v
                                                  ┌──────────┐
                                                  │ 完了通知 │
                                                  └──────────┘
```

## 実行結果の表示

### 実行ステータスの表示スタイル

| ステータス | アイコン | テキスト | 背景色 | 説明 |
|----------|---------|---------|--------|------|
| ready | ⏳ | Ready | #e8f4f8 | 実行準備完了 |
| doing | ⚙️ | 実行中 | #fff3e0 | 実行中（進行中） |
| success | ✅ | Success | #e8f5e9 | 実行成功 |
| failed | ❌ | Failed | #ffebee | 実行失敗 |

### 表示パターン

#### 1. 成功時
```
⏱️ 最新の実行結果:
┌────────────────────────────────────────────────────────┐
│ ✅ Success - 5.3秒                                     │
│ Successfully completed all 10 steps                    │
│ 開始: 2025-10-15 10:00:00                             │
│ 終了: 2025-10-15 10:00:05                             │
└────────────────────────────────────────────────────────┘
```

#### 2. 失敗時
```
⏱️ 最新の実行結果:
┌────────────────────────────────────────────────────────┐
│ ❌ Failed - 2.1秒                                      │
│ Failed at step 5: Element not found                   │
│ 開始: 2025-10-14 15:30:00                             │
│ 終了: 2025-10-14 15:30:02                             │
└────────────────────────────────────────────────────────┘
```

#### 3. 実行中
```
⏱️ 最新の実行結果:
┌────────────────────────────────────────────────────────┐
│ ⚙️ 実行中...                                           │
│ In progress: Step 3 of 8                               │
│ 開始: 2025-10-15 10:10:00                             │
└────────────────────────────────────────────────────────┘
```
**注意**: 実行中の場合、終了日時は表示しない

#### 4. 実行履歴なし
```
⏱️ 最新の実行結果:
┌────────────────────────────────────────────────────────┐
│ 📭 実行履歴なし                                        │
└────────────────────────────────────────────────────────┘
```

### CSS スタイル例

```css
.execution-result {
  margin-top: 12px;
  padding: 12px;
  border-radius: 6px;
  font-size: 12px;
}

.execution-result.ready {
  background: #e8f4f8;
  border: 1px solid #b3e5fc;
}

.execution-result.doing {
  background: #fff3e0;
  border: 1px solid #ffe0b2;
}

.execution-result.success {
  background: #e8f5e9;
  border: 1px solid #c8e6c9;
}

.execution-result.failed {
  background: #ffebee;
  border: 1px solid #ffcdd2;
}

.execution-result.no-history {
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  text-align: center;
  color: #999;
}

.execution-result-header {
  font-weight: 600;
  margin-bottom: 8px;
}

.execution-result-detail {
  margin-bottom: 8px;
  color: #555;
}

.execution-result-time {
  font-size: 11px;
  color: #777;
}
```

## インタラクション仕様

### ボタン動作

| ボタン | 動作 | 確認ダイアログ |
|-------|------|--------------|
| 新規作成 | 新規作成モーダルを表示 | なし |
| エクスポート | CSV生成してダウンロード | なし |
| インポート | ファイル選択ダイアログ表示 | あり（内容確認） |
| 編集 | 編集モーダルを表示（データ入力済み） | なし |
| 削除 | 削除確認ダイアログ表示 | あり |
| 複製 | 新しいIDで複製して保存 | なし |
| 保存 | バリデーション後に保存 | なし |
| キャンセル | モーダルを閉じる（変更破棄） | なし |
| 戻る | popup.html に戻る | なし |

### バリデーションルール

#### 新規作成/編集時

| フィールド | ルール | エラーメッセージ |
|----------|-------|----------------|
| サイト選択 | 必須 | サイトを選択してください |
| ステータス | 必須、3つのいずれか | 有効なステータスを選択してください |
| 変数名 | 英数字とアンダースコアのみ、1-50文字 | 変数名は英数字とアンダースコアのみ使用できます（1-50文字） |
| 変数値 | 0-1000文字 | 変数値は1000文字以内で入力してください |
| 重複変数名 | 同じ変数名は不可 | この変数名は既に使用されています |

#### インポート時

| 項目 | ルール | エラーメッセージ |
|-----|-------|----------------|
| ファイル形式 | CSVファイルのみ | CSVファイルを選択してください |
| ファイルサイズ | 10MB以下 | ファイルサイズが大きすぎます（10MB以下） |
| CSV構造 | 必須カラムが存在 | CSVの構造が不正です |
| データ形式 | 各行が正しい形式 | X行目のデータ形式が不正です |

### アクセシビリティ

- **キーボード操作**
  - Tab: フォーカス移動
  - Enter: ボタン押下/フォーム送信
  - Esc: モーダル閉じる
  - Space: チェックボックス/ラジオボタン選択

- **スクリーンリーダー対応**
  - aria-label: すべての操作可能要素
  - aria-describedby: エラーメッセージとの関連付け
  - role: 適切なARIAロール
  - alt: 画像の代替テキスト

- **フォーカス管理**
  - モーダル表示時: モーダル内にフォーカストラップ
  - モーダル閉じる時: 元の要素にフォーカス戻す
  - エラー時: エラー箇所にフォーカス移動

### レスポンシブ対応

| 画面幅 | 対応 |
|-------|-----|
| 800px以上 | デフォルトレイアウト |
| 600-799px | モーダル幅を90%に |
| 600px未満 | モーダル幅を95%に、フォント縮小 |

## データフォーマット

### CSV エクスポート形式

```csv
id,websiteId,status,variableName,variableValue,updatedAt
abc123,website-001,active,username,test@example.com,2025-10-15T10:30:45.000Z
abc123,website-001,active,password,secret123,2025-10-15T10:30:45.000Z
abc123,website-001,active,email,user@example.com,2025-10-15T10:30:45.000Z
xyz987,website-002,test,api_key,key12345,2025-10-14T15:20:30.000Z
xyz987,website-002,test,token,token67890,2025-10-14T15:20:30.000Z
```

**説明:**
- 各変数が1行になる形式（正規化形式）
- 同じAutomationVariablesのエントリは複数行に分割
- インポート時に同じIDでグルーピングして復元
- websiteName は含まない（表示時にWebsiteRepositoryから取得）

### localStorage 保存形式

```json
{
  "automationVariables": [
    {
      "id": "abc123-def456-ghi789",
      "websiteId": "website-001",
      "variables": {
        "username": "test@example.com",
        "password": "secret123",
        "email": "user@example.com"
      },
      "status": "active",
      "updatedAt": "2025-10-15T10:30:45.000Z"
    },
    {
      "id": "xyz987-uvw654-rst321",
      "websiteId": "website-002",
      "variables": {
        "api_key": "key12345",
        "token": "token67890",
        "endpoint": "https://api.example.com"
      },
      "status": "test",
      "updatedAt": "2025-10-14T15:20:30.000Z"
    }
  ]
}
```

**注意:**
- `websiteName` は保存せず、表示時に `websiteConfigs` から動的に取得
- `variables` は `{ [key: string]: string }` 型で、レコードごとに項目名と数が異なる

## エラー処理

### エラーの種類と表示方法

| エラー種類 | 表示方法 | メッセージ例 |
|----------|---------|------------|
| バリデーションエラー | フィールド下に赤文字 | "変数名は必須です" |
| 保存失敗 | トースト通知（赤） | "保存に失敗しました" |
| 読み込み失敗 | トースト通知（赤） | "データの読み込みに失敗しました" |
| 削除失敗 | トースト通知（赤） | "削除に失敗しました" |
| インポート失敗 | モーダル内にエラー一覧表示 | "3行目: 変数名が不正です" |
| ネットワークエラー | トースト通知（赤） | "ネットワークエラーが発生しました" |

### トースト通知の仕様

- **位置**: 画面右上
- **表示時間**: 3秒（自動消去）
- **閉じるボタン**: あり
- **アニメーション**: フェードイン/フェードアウト
- **スタッキング**: 複数表示時は縦に積む（最大3つ）

```
┌────────────────────────────────────┐
│ ✅ 保存に成功しました         [×] │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ ⚠️ データの一部に問題があります [×]│
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ ❌ 保存に失敗しました         [×] │
└────────────────────────────────────┘
```

## パフォーマンス要件

| 操作 | 目標時間 |
|-----|---------|
| 一覧表示（100件） | < 500ms |
| 一覧表示（1000件） | < 2s |
| モーダル表示 | < 100ms |
| 保存処理 | < 300ms |
| 削除処理 | < 200ms |
| エクスポート（100件） | < 1s |
| インポート（100件） | < 2s |
| フィルタリング | < 100ms |

## セキュリティ考慮事項

1. **変数値の表示**
   - パスワードや秘密鍵は `******` で表示
   - 編集時は平文で表示（必要に応じて）
   - コピー機能を提供

2. **XSS対策**
   - すべてのユーザー入力をエスケープ
   - innerHTML の使用を避ける
   - DOMPurify などのライブラリ使用を検討

3. **CSP (Content Security Policy)**
   - manifest.json に適切な CSP を設定
   - インラインスクリプトを避ける

4. **データ暗号化**
   - localStorage のデータは平文（Chrome拡張の制限）
   - 将来的に暗号化オプションを検討

## i18n メッセージキー（実行結果関連）

### 日本語 (ja/messages.json)

```json
{
  "latestExecutionResult": {
    "message": "⏱️ 最新の実行結果"
  },
  "noExecutionHistory": {
    "message": "📭 実行履歴なし"
  },
  "executionStatusReady": {
    "message": "Ready"
  },
  "executionStatusDoing": {
    "message": "実行中"
  },
  "executionStatusSuccess": {
    "message": "Success"
  },
  "executionStatusFailed": {
    "message": "Failed"
  },
  "executionDuration": {
    "message": "$duration$秒",
    "placeholders": {
      "duration": {
        "content": "$1"
      }
    }
  },
  "executionStartTime": {
    "message": "開始: $time$",
    "placeholders": {
      "time": {
        "content": "$1"
      }
    }
  },
  "executionEndTime": {
    "message": "終了: $time$",
    "placeholders": {
      "time": {
        "content": "$1"
      }
    }
  }
}
```

### 英語 (en/messages.json)

```json
{
  "latestExecutionResult": {
    "message": "⏱️ Latest Execution Result"
  },
  "noExecutionHistory": {
    "message": "📭 No execution history"
  },
  "executionStatusReady": {
    "message": "Ready"
  },
  "executionStatusDoing": {
    "message": "In Progress"
  },
  "executionStatusSuccess": {
    "message": "Success"
  },
  "executionStatusFailed": {
    "message": "Failed"
  },
  "executionDuration": {
    "message": "$duration$s",
    "placeholders": {
      "duration": {
        "content": "$1"
      }
    }
  },
  "executionStartTime": {
    "message": "Started: $time$",
    "placeholders": {
      "time": {
        "content": "$1"
      }
    }
  },
  "executionEndTime": {
    "message": "Ended: $time$",
    "placeholders": {
      "time": {
        "content": "$1"
      }
    }
  }
}
```

## 今後の拡張案

1. **検索機能**
   - 変数名での検索
   - 値での部分一致検索

2. **ソート機能**
   - サイト名順
   - 更新日時順
   - ステータス順
   - 実行成功率順

3. **一括操作**
   - 複数選択
   - 一括削除
   - 一括ステータス変更

4. **変数のテンプレート**
   - よく使う変数セットを保存
   - テンプレートから新規作成

5. **変数の暗号化**
   - パスワード等の機密情報を暗号化
   - マスターパスワードでロック

6. **実行履歴の詳細表示**
   - 全履歴を一覧表示
   - フィルタリング・ソート機能
   - 統計情報（成功率、平均実行時間）
   - 履歴のエクスポート

7. **通知機能**
   - 実行失敗時のデスクトップ通知
   - 成功時の通知（オプション）

8. **履歴の自動削除**
   - 古い履歴の自動削除設定
   - 保持期間・件数の設定
