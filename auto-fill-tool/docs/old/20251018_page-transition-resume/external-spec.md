# 画面遷移対応自動入力機能 - 外部仕様

## 概要

自動入力の実行中に画面遷移が発生した場合でも、遷移後のページで自動入力を中断せず、続きから自動的に再開する機能。

## ユースケース

### 1. 複数ページにまたがるフォーム入力

**シナリオ:**
1. ユーザーが会員登録フォームを開く
2. 自動入力が開始される
3. ページ1: 基本情報入力 → 「次へ」ボタンをクリック → ページ2へ遷移
4. ページ2: 追加情報入力 → 「次へ」ボタンをクリック → ページ3へ遷移
5. ページ3: 確認画面で「送信」ボタンをクリック

**期待される動作:**
- ページ遷移が発生しても自動入力が中断されない
- 各ページで自動入力が自動的に再開される
- ユーザーは何も操作する必要がない

### 2. SPA（Single Page Application）での画面遷移

**シナリオ:**
1. SPAで履歴検索フォームに自動入力
2. 検索ボタンクリック時、URLが変わり新しいページコンテンツが読み込まれる
3. 結果画面でさらに詳細検索フォームに自動入力

**期待される動作:**
- URL変更後も自動入力が継続される
- 新しいページの要素が読み込まれるまで待機
- 要素が利用可能になったら自動入力を再開

### 3. エラー時の処理

**シナリオ:**
1. 自動入力実行中にネットワークエラーでページ読み込みに失敗
2. ユーザーがページを再読み込み

**期待される動作:**
- 再読み込み後、前回の続きから自動入力を再開
- エラーが発生したステップからリトライ

## 機能要件

### FR-1: 実行状態の永続化

自動入力の実行中、以下の情報を保存する：
- 現在実行中のステップ位置
- 実行中の自動入力設定ID
- 最後に実行されたURL

### FR-2: ページロード時の自動再開

ページが読み込まれた際、以下を自動的に実行：
1. 実行中の自動入力があるかチェック
2. 現在のURLが次のステップのURLと一致するかチェック
3. 一致する場合、続きから自動入力を再開

### FR-3: ユーザーへの通知

実行状態を視覚的に表示：
- 「自動入力実行中」のインジケーター表示
- 進捗状況（例: "5/20ステップ実行済み"）
- エラー発生時の通知

### FR-4: 手動での中断

ユーザーが自動入力を手動で中断可能：
- 拡張機能のポップアップから「停止」ボタン
- 中断すると実行状態がクリアされる

## 非機能要件

### NFR-1: パフォーマンス

- 実行状態の保存はページ遷移時のみ（全ステップで保存しない）
- Chrome Storageへの書き込み回数を最小限に抑える

### NFR-2: 信頼性

- ネットワークエラーや拡張機能の再起動後も状態を復元可能
- 24時間以上経過した実行中の状態は自動的にクリア

### NFR-3: 互換性

- 既存の自動入力機能との完全な互換性
- 既存のデータ構造を保持（マイグレーション不要）

## 制約事項

### C-1: URLベースの再開

次に実行すべきステップのURLと現在のページURLが一致する場合のみ再開される。URLが異なる場合は再開されない。

### C-2: タブ識別

同じ自動入力設定を複数タブで同時実行している場合、タブを特定できない可能性がある。この場合、最初に見つかったタブで再開される。

### C-3: 手動操作との競合

ユーザーが手動でフォームを操作した場合、自動入力との競合が発生する可能性がある。

## 用語集

- **自動入力**: XPathデータに基づいてフォームフィールドに自動的に値を入力する処理
- **ステップ**: 自動入力の1つの操作単位（例: テキスト入力、ボタンクリック）
- **実行状態**: 自動入力の進行状況を表すデータ
- **画面遷移**: URLの変更やページの再読み込み
- **再開**: 中断された自動入力を続きから実行すること
