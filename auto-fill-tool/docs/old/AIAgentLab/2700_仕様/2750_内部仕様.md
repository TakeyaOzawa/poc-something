## ğŸ§± 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

ã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  (MAS)**ã€**æ°¸ç¶šãƒ‡ãƒ¼ã‚¿å±¤**ã€ãŠã‚ˆã³**å¤–éƒ¨é–‹ç™ºç’°å¢ƒ** ã‚’æ ¸ã¨ã—ã¦æ§‹æˆã•ã‚Œã‚‹ã€‚

| å±¤ | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | æŠ€è¡“/å½¹å‰² |
| :--- | :--- | :--- |
| **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå±¤ (MAS)** | Planner, Architect, Coder, Tester | ç‹¬ç«‹ã—ãŸå½¹å‰²ã‚’æŒã¡ã€LLMã‚’ç”¨ã„ã¦ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚ |
| **é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«** | MCP (Multi-Context Protocol) | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ãŠã‚ˆã³Amazon Qã¨ã®å¯¾è©±ã¨ã‚¿ã‚¹ã‚¯ã®å—ã‘æ¸¡ã—ã‚’è¡Œã†ã€‚ |
| **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šå±¤** | AWS EFS (ã‚¯ãƒ©ã‚¦ãƒ‰) / Docker Volume (ãƒ­ãƒ¼ã‚«ãƒ«) | é–‹ç™ºå¯¾è±¡ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ`/project_root`ï¼‰ã‚’æ°¸ç¶šçš„ã«ä¿æŒãƒ»å…±æœ‰ã€‚ |
| **å¤–éƒ¨é–‹ç™ºç’°å¢ƒ** | æ¤œè¨¼ç’°å¢ƒã‚³ãƒ³ãƒ†ãƒŠç¾¤ (PHP, MySQL, Redisç­‰) | AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ç‹¬ç«‹ã—ã¦èµ·å‹•ã—ã€çµ±åˆãƒ†ã‚¹ãƒˆãƒ»å‹•ä½œæ¤œè¨¼ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚ |
| **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤** | k3s (ãƒ­ãƒ¼ã‚«ãƒ«) / Amazon EKS (AWS) | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒŠã¨å¤–éƒ¨ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç®¡ç†ã€‚ |


éšå±¤æ§‹é€ æ¡ˆ
/ai-dev-project
â”œâ”€â”€ .git/
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt         # Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª (boto3, fastapi, requestsãªã©)
â”œâ”€â”€ docker-compose.yml       # AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ
â”œâ”€â”€ package.json             # CDKç”¨ä¾å­˜é–¢ä¿‚
â”œâ”€â”€ tsconfig.json            # CDKç”¨TypeScriptè¨­å®š
â”‚
â”œâ”€â”€ /cdk
â”‚   â”œâ”€â”€ app.ts
â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â””â”€â”€ ai-dev-stack.ts  # AWSãƒªã‚½ãƒ¼ã‚¹å®šç¾© (EKS, EFS, IAM)
â”‚   â””â”€â”€ cdk.json
â”‚
â”œâ”€â”€ /k8s                     # Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ ai-agents/           # AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â”œâ”€â”€ planner-agent.yaml
â”‚   â”‚   â”œâ”€â”€ architect-agent.yaml
â”‚   â”‚   â”œâ”€â”€ coder-agent.yaml
â”‚   â”‚   â””â”€â”€ tester-agent.yaml
â”‚   â””â”€â”€ external-env/        # å¤–éƒ¨é–‹ç™ºç’°å¢ƒç”¨
â”‚       â”œâ”€â”€ namespace.yaml
â”‚       â”œâ”€â”€ php-app.yaml
â”‚       â”œâ”€â”€ mysql.yaml
â”‚       â””â”€â”€ redis.yaml
â”‚
â”œâ”€â”€ /agents                  # AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…
â”‚   â”œâ”€â”€ /planner-agent
â”‚   â”‚   â”œâ”€â”€ Dockerfile       # Node.js 22 + Python
â”‚   â”‚   â”œâ”€â”€ logic.py         # MCPã‚µãƒ¼ãƒãƒ¼/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ config.json      # Amazon Q ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (Planner)
â”‚   â”œâ”€â”€ /architect-agent
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ logic.py
â”‚   â”‚   â””â”€â”€ config.json      # Amazon Q ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (Architect)
â”‚   â”œâ”€â”€ /coder-agent
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ logic.py
â”‚   â”‚   â””â”€â”€ config.json      # Amazon Q ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (Coder)
â”‚   â””â”€â”€ /tester-agent
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â”œâ”€â”€ logic.py
â”‚       â””â”€â”€ config.json      # Amazon Q ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (Tester)
â”‚
â””â”€â”€ /project_root            # AIãŒé–‹ç™ºå¯¾è±¡ã¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ (EFSãƒã‚¦ãƒ³ãƒˆå¯¾è±¡)
    â”œâ”€â”€ src/
    â”œâ”€â”€ docker-compose.yml   # å¤–éƒ¨é–‹ç™ºç’°å¢ƒç”¨ï¼ˆPHP, MySQL, Redisç­‰ï¼‰
    â””â”€â”€ package.json

---

## 2. ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜

### 2.1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: k3s + Kubernetes

èª¿æŸ»çµæœã«åŸºã¥ãã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯è»½é‡ãªk3sã‚’æ¡ç”¨ã—ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’åˆ†é›¢ã—ã¦ç®¡ç†ã—ã¾ã™ã€‚

#### k3sã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# k3sã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ARM64å¯¾å¿œ)
curl -sfL https://get.k3s.io | sh -

# kubectlã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®š
echo 'alias kubectl="sudo k3s kubectl"' >> ~/.bashrc
source ~/.bashrc
```

#### ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹åˆ†é›¢
```yaml
# k8s/ai-agents/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ai-agents
---
# k8s/external-env/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: external-env
```

### 2.2. AWSç’°å¢ƒ: Amazon EKS

AWSç’°å¢ƒã§ã¯ã€EKSã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### CDKæ§‹æˆ (æ›´æ–°ç‰ˆ)
```typescript
// cdk/lib/ai-dev-stack.ts
import * as eks from 'aws-cdk-lib/aws-eks';
import * as ec2 from 'aws-cdk-lib/aws-ec2';

export class AiDevStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // VPC
    const vpc = new ec2.Vpc(this, 'AiDevVpc', {
      maxAzs: 2
    });

    // EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ (ARM64å¯¾å¿œ)
    const cluster = new eks.Cluster(this, 'AiDevCluster', {
      vpc,
      version: eks.KubernetesVersion.V1_28,
      defaultCapacity: 0
    });

    // ARM64ãƒãƒ¼ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ— (Graviton)
    cluster.addNodegroupCapacity('arm64-nodes', {
      instanceTypes: [ec2.InstanceType.of(
        ec2.InstanceClass.M6G, 
        ec2.InstanceSize.MEDIUM
      )],
      minSize: 1,
      maxSize: 5
    });

    // EFS for persistent storage
    const fileSystem = new efs.FileSystem(this, 'ProjectEFS', {
      vpc,
      performanceMode: efs.PerformanceMode.GENERAL_PURPOSE
    });
  }
}
```

## 3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡ä»•æ§˜ã¨ã‚³ãƒãƒ³ãƒ‰

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®ä¼šè©±ã¯ã€HTTPãƒ™ãƒ¼ã‚¹ã®MCPã‚µãƒ¼ãƒãƒ¼ã‚’é€šã˜ã¦è¡Œã‚ã‚Œã¾ã™ã€‚å¤–éƒ¨é–‹ç™ºç’°å¢ƒã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯Kubernetes Service Discoveryã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### 3.1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€£æºã‚³ãƒãƒ³ãƒ‰ä½“ç³»

#### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰æ§‹é€ 
```python
# æ¨™æº–çš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "command": "COMMAND_TYPE",
    "sender": "AgentName",
    "target": "TargetAgent",
    "payload": {
        "task_id": "unique_task_id",
        "priority": "high|medium|low",
        "context": {},
        "data": {}
    },
    "callback_url": "http://sender-agent:port/callback",
    "timeout": 30
}
```

#### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€£æºã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

| ã‚³ãƒãƒ³ãƒ‰ | é€ä¿¡è€… | å—ä¿¡è€… | ç”¨é€” | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹ |
|---------|--------|--------|------|-------------|
| **PLAN_TASK** | Planner | Architect | ã‚¿ã‚¹ã‚¯è¨ˆç”»ã®è¨­è¨ˆä¾é ¼ | `{"requirements": "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚", "constraints": "åˆ¶ç´„æ¡ä»¶"}` |
| **DESIGN_REVIEW** | Architect | Planner | è¨­è¨ˆå®Œäº†å ±å‘Š | `{"design_doc": "è¨­è¨ˆæ›¸", "tech_stack": ["PHP", "MySQL"]}` |
| **CODE_REQUEST** | Architect | Coder | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¾é ¼ | `{"specifications": "ä»•æ§˜", "files": ["controller.php"]}` |
| **CODE_COMPLETE** | Coder | Tester | ã‚³ãƒ¼ãƒ‰å®Œæˆé€šçŸ¥ | `{"files": ["src/app.php"], "dependencies": ["mysql", "redis"]}` |
| **TEST_REQUEST** | Coder | Tester | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾é ¼ | `{"test_type": "unit|integration", "target_files": []}` |
| **TEST_RESULT** | Tester | Coder | ãƒ†ã‚¹ãƒˆçµæœå ±å‘Š | `{"status": "pass|fail", "errors": [], "coverage": 85}` |
| **DEPLOY_REQUEST** | Tester | Coder | ãƒ‡ãƒ—ãƒ­ã‚¤ä¾é ¼ | `{"environment": "staging|production", "config": {}}` |
| **TASK_COMPLETE** | Any | Planner | ã‚¿ã‚¹ã‚¯å®Œäº†å ±å‘Š | `{"task_id": "xxx", "result": "success", "artifacts": []}` |

### 3.2. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡å®Ÿè£…ä¾‹ï¼ˆCoderãŒTesterã‚’å‘¼ã³å‡ºã™ï¼‰

CoderAgentã®`logic.py`å†…ã§ã€TesterAgentã®MCPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ã€Œä¼šè©±ã€ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

```python
# agents/coder-agent/logic.py - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡ä¾‹
import requests
import asyncio
from typing import Dict, Any

class AgentCommunicator:
    def __init__(self, agent_name: str):
        self.agent_name = agent_name
        self.endpoints = {
            "planner": "http://planner-agent.ai-agents.svc.cluster.local:8080/mcp",
            "architect": "http://architect-agent.ai-agents.svc.cluster.local:8081/mcp", 
            "coder": "http://coder-agent.ai-agents.svc.cluster.local:8082/mcp",
            "tester": "http://tester-agent.ai-agents.svc.cluster.local:8083/mcp"
        }
    
    async def send_command(self, target_agent: str, command: str, payload: Dict[Any, Any]) -> Dict[Any, Any]:
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã‚³ãƒãƒ³ãƒ‰é€ä¿¡"""
        message = {
            "command": command,
            "sender": self.agent_name,
            "target": target_agent,
            "payload": payload,
            "callback_url": f"http://{self.agent_name.lower()}-agent.ai-agents.svc.cluster.local:{self._get_port()}/callback",
            "timeout": 30
        }
        
        try:
            response = requests.post(
                self.endpoints[target_agent.lower()], 
                json=message,
                timeout=30
            )
            return response.json()
        except Exception as e:
            return {"error": str(e), "status": "failed"}
    
    def _get_port(self) -> int:
        port_map = {"planner": 8080, "architect": 8081, "coder": 8082, "tester": 8083}
        return port_map.get(self.agent_name.lower(), 8080)

# ä½¿ç”¨ä¾‹: CoderãŒTesterã«ãƒ†ã‚¹ãƒˆä¾é ¼
communicator = AgentCommunicator("Coder")
result = await communicator.send_command("tester", "TEST_REQUEST", {
    "task_id": "test_001",
    "test_type": "integration",
    "target_files": ["src/UserController.php", "src/AuthService.php"],
    "external_services": ["mysql", "redis"],
    "priority": "high"
})
```

| é …ç›® | è©³ç´° |
| :--- | :--- |
| **å®Ÿè¡Œç’°å¢ƒ** | CoderAgentã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ |
| **å¯¾è±¡URL** | `http://tester-agent.ai-agents.svc.cluster.local:8083/mcp` |
| **ã‚³ãƒãƒ³ãƒ‰** | `TEST_REQUEST` |
| **ç›®çš„** | CoderãŒã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾Œã€Testerã«çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’ä¾é ¼ã—ã€çµæœã‚’å¾…ã¤ï¼ˆåŒæœŸçš„ãªã€Œä¼šè©±ã€ï¼‰ã€‚ |

### 3.2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒãƒ¼ãƒˆ

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå | ã‚µãƒ¼ãƒ“ã‚¹å (Kubernetes) | MCPãƒãƒ¼ãƒˆ | å½¹å‰² |
| :--- | :--- | :--- | :--- |
| **PlannerAgent** | `planner-agent.ai-agents.svc.cluster.local` | 8080 | ã‚¿ã‚¹ã‚¯æŒ‡ç¤ºãƒ»å®Œäº†å ±å‘Š |
| **ArchitectAgent** | `architect-agent.ai-agents.svc.cluster.local` | 8081 | è¨­è¨ˆæƒ…å ±æä¾› |
| **CoderAgent** | `coder-agent.ai-agents.svc.cluster.local` | 8082 | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ä¿®æ­£ãƒ»å®Ÿè¡Œ |
| **TesterAgent** | `tester-agent.ai-agents.svc.cluster.local` | 8083 | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ãƒã‚°å ±å‘Š |

### 3.3. å¤–éƒ¨é–‹ç™ºç’°å¢ƒã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

| ã‚µãƒ¼ãƒ“ã‚¹å | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒãƒ¼ãƒˆ | ç”¨é€” |
| :--- | :--- | :--- | :--- |
| **PHP Application** | `php-app.external-env.svc.cluster.local` | 9000 | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ»ãƒ†ã‚¹ãƒˆ |
| **MySQL Database** | `mysql.external-env.svc.cluster.local` | 3306 | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œãƒ»ãƒ†ã‚¹ãƒˆ |
| **Redis Cache** | `redis.external-env.svc.cluster.local` | 6379 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œãƒ»ãƒ†ã‚¹ãƒˆ |
| **Nginx Web Server** | `nginx.external-env.svc.cluster.local` | 80 | HTTP ã‚¢ã‚¯ã‚»ã‚¹ãƒ»E2Eãƒ†ã‚¹ãƒˆ |

### 3.4. å¤–éƒ¨ç’°å¢ƒã‚¢ã‚¯ã‚»ã‚¹å®Ÿè£…

#### å¤–éƒ¨ç’°å¢ƒã‚¢ã‚¯ã‚»ã‚¹ã‚¯ãƒ©ã‚¹
```python
# agents/common/external_env_client.py
import requests
import mysql.connector
import redis
import subprocess
from typing import Dict, Any

class ExternalEnvironmentClient:
    def __init__(self):
        self.endpoints = {
            "php": "php-app.external-env.svc.cluster.local:9000",
            "mysql": "mysql.external-env.svc.cluster.local:3306", 
            "redis": "redis.external-env.svc.cluster.local:6379",
            "nginx": "nginx.external-env.svc.cluster.local:80"
        }
        self.mysql_config = {
            "host": "mysql.external-env.svc.cluster.local",
            "port": 3306,
            "user": "testuser",
            "password": "testpass",
            "database": "testdb"
        }
    
    async def execute_php_command(self, command: str, args: Dict[str, Any] = None) -> Dict[str, Any]:
        """PHP ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ"""
        try:
            url = f"http://{self.endpoints['nginx']}/api/execute"
            payload = {"command": command, "args": args or {}}
            response = requests.post(url, json=payload, timeout=30)
            return {
                "success": response.status_code == 200,
                "status_code": response.status_code,
                "data": response.json() if response.status_code == 200 else None,
                "error": response.text if response.status_code != 200 else None
            }
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def execute_mysql_query(self, query: str, params: tuple = None) -> Dict[str, Any]:
        """MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªå®Ÿè¡Œ"""
        try:
            conn = mysql.connector.connect(**self.mysql_config)
            cursor = conn.cursor(dictionary=True)
            cursor.execute(query, params or ())
            
            if query.strip().upper().startswith('SELECT'):
                result = cursor.fetchall()
            else:
                conn.commit()
                result = {"affected_rows": cursor.rowcount}
            
            cursor.close()
            conn.close()
            return {"success": True, "data": result}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def execute_redis_command(self, command: str, *args) -> Dict[str, Any]:
        """Redis ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ"""
        try:
            host, port = self.endpoints['redis'].split(':')
            r = redis.Redis(host=host, port=int(port), decode_responses=True)
            result = getattr(r, command.lower())(*args)
            return {"success": True, "data": result}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def deploy_code(self, files: Dict[str, str]) -> Dict[str, Any]:
        """ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤–éƒ¨ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤"""
        try:
            results = {}
            for file_path, content in files.items():
                deploy_result = await self._deploy_file(file_path, content)
                results[file_path] = deploy_result
            
            reload_result = await self.execute_php_command("reload")
            results["php_reload"] = reload_result
            
            return {"success": True, "deployment_results": results}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def _deploy_file(self, file_path: str, content: str) -> Dict[str, Any]:
        """å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤"""
        try:
            import tempfile
            import os
            
            with tempfile.NamedTemporaryFile(mode='w', delete=False) as tmp_file:
                tmp_file.write(content)
                tmp_file_path = tmp_file.name
            
            kubectl_cmd = [
                "kubectl", "cp", tmp_file_path,
                f"external-env/php-app-pod:{file_path}"
            ]
            result = subprocess.run(kubectl_cmd, capture_output=True, text=True)
            os.unlink(tmp_file_path)
            
            return {
                "success": result.returncode == 0,
                "output": result.stdout,
                "error": result.stderr if result.returncode != 0 else None
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    async def run_integration_test(self, test_suite: str) -> Dict[str, Any]:
        """çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ"""
        try:
            test_result = await self.execute_php_command("run_tests", {"suite": test_suite})
            db_test = await self.execute_mysql_query("SELECT 1 as test")
            redis_test = await self.execute_redis_command("ping")
            
            return {
                "success": True,
                "test_results": {
                    "application": test_result,
                    "database": db_test,
                    "cache": redis_test
                }
            }
        except Exception as e:
            return {"success": False, "error": str(e)}
```

### 3.5. TesterAgentã®çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…

```python
# agents/tester-agent/logic.py
from common.external_env_client import ExternalEnvironmentClient

class TesterAgent:
    def __init__(self):
        self.external_client = ExternalEnvironmentClient()
        self.communicator = AgentCommunicator("Tester")
    
    async def handle_test_request(self, request_data: Dict[str, Any]):
        """ãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†"""
        test_type = request_data.get("test_type", "unit")
        
        if test_type == "integration":
            return await self.run_integration_tests(request_data)
        elif test_type == "e2e":
            return await self.run_e2e_tests(request_data)
        else:
            return await self.run_unit_tests(request_data)
    
    async def run_integration_tests(self, request_data: Dict[str, Any]) -> Dict[str, Any]:
        """çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        try:
            # 1. å¤–éƒ¨ç’°å¢ƒã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
            health_check = await self.external_client.run_integration_test("health")
            
            if not health_check["success"]:
                return {"status": "environment_error", "error": health_check["error"]}
            
            # 2. ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            deployed_files = request_data.get("deployed_files", [])
            test_results = {}
            
            for file_path in deployed_files:
                test_name = file_path.replace("/", "_").replace(".php", "")
                test_result = await self.external_client.execute_php_command(
                    "run_phpunit", 
                    {"test_file": f"tests/{test_name}Test.php"}
                )
                test_results[file_path] = test_result
            
            # 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
            db_tests = await self.run_database_tests()
            
            # 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±åˆãƒ†ã‚¹ãƒˆ
            cache_tests = await self.run_cache_tests()
            
            # 5. CoderAgentã«çµæœå ±å‘Š
            await self.communicator.send_command("coder", "TEST_RESULT", {
                "task_id": request_data.get("task_id"),
                "status": "completed",
                "results": {
                    "health_check": health_check,
                    "file_tests": test_results,
                    "database_tests": db_tests,
                    "cache_tests": cache_tests
                }
            })
            
            return {"status": "test_completed", "results": test_results}
            
        except Exception as e:
            return {"status": "test_failed", "error": str(e)}
    
    async def run_database_tests(self) -> Dict[str, Any]:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ"""
        tests = [
            ("connection", "SELECT 1"),
            ("create_table", "CREATE TEMPORARY TABLE test_tmp (id INT)"),
            ("insert_data", "INSERT INTO test_tmp VALUES (1)"),
            ("select_data", "SELECT * FROM test_tmp"),
            ("drop_table", "DROP TABLE test_tmp")
        ]
        
        results = {}
        for test_name, query in tests:
            result = await self.external_client.execute_mysql_query(query)
            results[test_name] = result
        
        return results
    
    async def run_cache_tests(self) -> Dict[str, Any]:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ"""
        tests = [
            ("ping", "ping"),
            ("set_key", "set", "test_key", "test_value"),
            ("get_key", "get", "test_key"),
            ("delete_key", "delete", "test_key")
        ]
        
        results = {}
        for test_name, *args in tests:
            result = await self.external_client.execute_redis_command(*args)
            results[test_name] = result
        
        return results
```

### 3.6. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹

#### å®Œå…¨ãªé–‹ç™ºãƒ•ãƒ­ãƒ¼
```python
# 1. PlannerAgent -> ArchitectAgent
await planner.send_command("architect", "PLAN_TASK", {
    "requirements": "ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…",
    "constraints": ["PHP 8.2", "MySQL 8.0", "Redis"]
})

# 2. ArchitectAgent -> CoderAgent  
await architect.send_command("coder", "CODE_REQUEST", {
    "specifications": {
        "auth_controller": "JWTèªè¨¼ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½",
        "user_model": "ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®CRUDæ“ä½œ",
        "middleware": "èªè¨¼ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢"
    },
    "files": ["AuthController.php", "User.php", "AuthMiddleware.php"]
})

# 3. CoderAgent -> TesterAgent
await coder.send_command("tester", "TEST_REQUEST", {
    "test_type": "integration",
    "deployed_files": ["AuthController.php", "User.php"],
    "external_services": ["mysql", "redis"]
})

# 4. TesterAgent -> CoderAgent (çµæœå ±å‘Š)
await tester.send_command("coder", "TEST_RESULT", {
    "status": "pass",
    "coverage": 95,
    "performance": {"response_time": "120ms"}
})

# 5. CoderAgent -> PlannerAgent (å®Œäº†å ±å‘Š)
await coder.send_command("planner", "TASK_COMPLETE", {
    "status": "success",
    "artifacts": ["AuthController.php", "User.php", "AuthMiddleware.php"],
    "test_results": "All tests passed"
})
```

---

## 4. Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå®Ÿè£…

### 4.1. AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ

#### CoderAgentä¾‹
```yaml
# k8s/ai-agents/coder-agent.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coder-agent
  namespace: ai-agents
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coder-agent
  template:
    metadata:
      labels:
        app: coder-agent
    spec:
      containers:
      - name: coder-agent
        image: coder-agent:latest
        ports:
        - containerPort: 8082
        env:
        - name: EXTERNAL_PHP_URL
          value: "http://php-app.external-env.svc.cluster.local:9000"
        - name: EXTERNAL_MYSQL_URL
          value: "mysql.external-env.svc.cluster.local:3306"
        - name: EXTERNAL_REDIS_URL
          value: "redis.external-env.svc.cluster.local:6379"
        volumeMounts:
        - name: project-storage
          mountPath: /app/project_root
      volumes:
      - name: project-storage
        persistentVolumeClaim:
          claimName: project-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: coder-agent
  namespace: ai-agents
spec:
  selector:
    app: coder-agent
  ports:
  - port: 8082
    targetPort: 8082
```

### 4.2. å¤–éƒ¨é–‹ç™ºç’°å¢ƒç”¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ

#### PHP + MySQL + Redis ã‚¹ã‚¿ãƒƒã‚¯
```yaml
# k8s/external-env/php-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-app
  namespace: external-env
spec:
  replicas: 1
  selector:
    matchLabels:
      app: php-app
  template:
    metadata:
      labels:
        app: php-app
    spec:
      containers:
      - name: php
        image: php:8.2-fpm-alpine
        ports:
        - containerPort: 9000
        volumeMounts:
        - name: app-code
          mountPath: /var/www/html
      volumes:
      - name: app-code
        persistentVolumeClaim:
          claimName: project-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: php-app
  namespace: external-env
spec:
  selector:
    app: php-app
  ports:
  - port: 9000
    targetPort: 9000
```

```yaml
# k8s/external-env/mysql.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: external-env
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "password"
        - name: MYSQL_DATABASE
          value: "testdb"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: external-env
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
```

### 4.3. ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# manage-k8s.sh

case $1 in
  "start-agents")
    kubectl apply -f k8s/ai-agents/
    echo "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ·å‹•ã—ã¾ã—ãŸ"
    ;;
  "start-external")
    kubectl apply -f k8s/external-env/
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã—ãŸ"
    ;;
  "start-all")
    kubectl apply -f k8s/ai-agents/
    kubectl apply -f k8s/external-env/
    echo "å…¨ç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã—ãŸ"
    ;;
  "stop-agents")
    kubectl delete -f k8s/ai-agents/
    echo "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åœæ­¢ã—ã¾ã—ãŸ"
    ;;
  "stop-external")
    kubectl delete -f k8s/external-env/
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’åœæ­¢ã—ã¾ã—ãŸ"
    ;;
  "stop-all")
    kubectl delete -f k8s/ai-agents/
    kubectl delete -f k8s/external-env/
    echo "å…¨ç’°å¢ƒã‚’åœæ­¢ã—ã¾ã—ãŸ"
    ;;
  "status")
    echo "=== AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ==="
    kubectl get pods -n ai-agents
    echo "=== å¤–éƒ¨é–‹ç™ºç’°å¢ƒ ==="
    kubectl get pods -n external-env
    ;;
  "logs")
    kubectl logs -n $2 -l app=$3 -f
    ;;
  *)
    echo "ä½¿ç”¨æ–¹æ³•: $0 {start-agents|start-external|start-all|stop-agents|stop-external|stop-all|status|logs <namespace> <app>}"
    ;;
esac
```

## 6. å¤–éƒ¨é–‹ç™ºç’°å¢ƒã¨ã®çµ±åˆ

### 6.1. project_root/docker-compose.yml (å¤–éƒ¨é–‹ç™ºç’°å¢ƒç”¨)

AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ç‹¬ç«‹ã—ã¦èµ·å‹•ã™ã‚‹é–‹ç™ºç’°å¢ƒã®æ§‹æˆã§ã™ã€‚

```yaml
# project_root/docker-compose.yml
version: '3.8'
services:
  php-app:
    image: php:8.2-fpm-alpine
    container_name: external-php-app
    volumes:
      - ./src:/var/www/html
    ports:
      - "9000:9000"
    depends_on:
      - mysql
      - redis
    networks:
      - external-dev-net

  nginx:
    image: nginx:alpine
    container_name: external-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./src:/var/www/html
    depends_on:
      - php-app
    networks:
      - external-dev-net

  mysql:
    image: mysql:8.0
    container_name: external-mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: testdb
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - external-dev-net

  redis:
    image: redis:alpine
    container_name: external-redis
    ports:
      - "6379:6379"
    networks:
      - external-dev-net

volumes:
  mysql_data:

networks:
  external-dev-net:
    driver: bridge
```

### 6.2. çµ±åˆãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

```python
# agents/tester-agent/integration_tests.py
import requests
import mysql.connector
import redis
import json

class IntegrationTestSuite:
    def __init__(self, php_url, mysql_url, redis_url):
        self.php_url = php_url
        self.mysql_url = mysql_url
        self.redis_url = redis_url
    
    async def run_full_test_suite(self):
        """å®Œå…¨ãªçµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œ"""
        results = {
            "database_tests": await self.test_database_operations(),
            "cache_tests": await self.test_cache_operations(),
            "application_tests": await self.test_application_endpoints(),
            "integration_tests": await self.test_full_integration()
        }
        return results
    
    async def test_database_operations(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œãƒ†ã‚¹ãƒˆ"""
        try:
            host, port = self.mysql_url.split(':')
            conn = mysql.connector.connect(
                host=host, port=int(port),
                user='testuser', password='testpass',
                database='testdb'
            )
            cursor = conn.cursor()
            
            # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ãƒ»å–å¾—ãƒ»å‰Šé™¤
            cursor.execute("CREATE TABLE IF NOT EXISTS test_table (id INT PRIMARY KEY, name VARCHAR(100))")
            cursor.execute("INSERT INTO test_table (id, name) VALUES (1, 'test')")
            cursor.execute("SELECT * FROM test_table WHERE id = 1")
            result = cursor.fetchone()
            cursor.execute("DELETE FROM test_table WHERE id = 1")
            
            conn.commit()
            conn.close()
            
            return {"success": True, "data": result}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def test_cache_operations(self):
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œãƒ†ã‚¹ãƒˆ"""
        try:
            host, port = self.redis_url.split(':')
            r = redis.Redis(host=host, port=int(port), decode_responses=True)
            
            # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®è¨­å®šãƒ»å–å¾—ãƒ»å‰Šé™¤
            r.set('test_key', 'test_value')
            value = r.get('test_key')
            r.delete('test_key')
            
            return {"success": True, "value": value}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    async def test_application_endpoints(self):
        """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ"""
        try:
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            health_response = requests.get(f"http://{self.php_url}/health")
            
            # API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
            api_response = requests.post(f"http://{self.php_url}/api/test", 
                                       json={"test": "data"})
            
            return {
                "success": True,
                "health_status": health_response.status_code,
                "api_status": api_response.status_code,
                "api_response": api_response.json() if api_response.status_code == 200 else None
            }
        except Exception as e:
            return {"success": False, "error": str(e)}
```

### 6.3. ç’°å¢ƒç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# project_root/manage-external-env.sh

case $1 in
  "start")
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ä¸­..."
    docker-compose -f docker-compose.yml up -d
    echo "èµ·å‹•å®Œäº†: http://localhost:8080"
    ;;
  "stop")
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’åœæ­¢ä¸­..."
    docker-compose -f docker-compose.yml down
    ;;
  "restart")
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’å†èµ·å‹•ä¸­..."
    docker-compose -f docker-compose.yml restart
    ;;
  "logs")
    docker-compose -f docker-compose.yml logs -f $2
    ;;
  "status")
    docker-compose -f docker-compose.yml ps
    ;;
  "clean")
    echo "å¤–éƒ¨é–‹ç™ºç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
    docker-compose -f docker-compose.yml down -v
    docker system prune -f
    ;;
  *)
    echo "ä½¿ç”¨æ–¹æ³•: $0 {start|stop|restart|logs <service>|status|clean}"
    ;;
esac
```

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢

### 7.1. Kubernetes NetworkPolicy

```yaml
# k8s/network-policies/ai-agents-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-agents-policy
  namespace: ai-agents
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ai-agents
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: ai-agents
  - to:
    - namespaceSelector:
        matchLabels:
          name: external-env
    ports:
    - protocol: TCP
      port: 9000  # PHP
    - protocol: TCP
      port: 3306  # MySQL
    - protocol: TCP
      port: 6379  # Redis
```

### 7.2. AWS EKS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—

```typescript
// cdk/lib/ai-dev-stack.ts (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£éƒ¨åˆ†)
const agentSecurityGroup = new ec2.SecurityGroup(this, 'AgentSecurityGroup', {
  vpc,
  description: 'Security group for AI agents',
  allowAllOutbound: false
});

const externalEnvSecurityGroup = new ec2.SecurityGroup(this, 'ExternalEnvSecurityGroup', {
  vpc,
  description: 'Security group for external development environment'
});

// AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®é€šä¿¡ã‚’è¨±å¯
agentSecurityGroup.addIngressRule(
  agentSecurityGroup,
  ec2.Port.tcpRange(8080, 8083),
  'Allow inter-agent communication'
);

// AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å¤–éƒ¨ç’°å¢ƒã¸ã®é€šä¿¡ã‚’è¨±å¯
agentSecurityGroup.addEgressRule(
  externalEnvSecurityGroup,
  ec2.Port.tcp(9000),
  'Allow access to PHP application'
);

agentSecurityGroup.addEgressRule(
  externalEnvSecurityGroup,
  ec2.Port.tcp(3306),
  'Allow access to MySQL'
);

agentSecurityGroup.addEgressRule(
  externalEnvSecurityGroup,
  ec2.Port.tcp(6379),
  'Allow access to Redis'
);
```

### 5.1. agents/coder-agent/Dockerfile (Node.js 22 + Python)

```dockerfile
FROM node:22-slim

# OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: Python, pip, Git, MySQL client
RUN apt-get update && apt-get install -y \
    python3 python3-pip git \
    mysql-client redis-tools \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY ./agents/coder-agent/logic.py /app/agent_logic/coder.py
COPY ./agents/coder-agent/config.json /app/config/coder.json

# èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ (Coderã®MCPã‚µãƒ¼ãƒãƒ¼ã‚’FastAPI/Uvicornã§èµ·å‹•)
CMD ["uvicorn", "agent_logic.coder:app", "--host", "0.0.0.0", "--port", "8082"]
```

### 5.2. agents/coder-agent/logic.py (å¤–éƒ¨ç’°å¢ƒã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œç‰ˆ)

```python
from fastapi import FastAPI, Request
import json
import requests
import os
import subprocess

app = FastAPI()
AGENT_NAME = "CoderAgent"
TESTER_URL = "http://tester-agent.ai-agents.svc.cluster.local:8083/mcp"

# å¤–éƒ¨é–‹ç™ºç’°å¢ƒã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
EXTERNAL_PHP_URL = os.getenv("EXTERNAL_PHP_URL", "http://php-app.external-env.svc.cluster.local:9000")
EXTERNAL_MYSQL_URL = os.getenv("EXTERNAL_MYSQL_URL", "mysql.external-env.svc.cluster.local:3306")
EXTERNAL_REDIS_URL = os.getenv("EXTERNAL_REDIS_URL", "redis.external-env.svc.cluster.local:6379")

@app.post("/mcp")
async def handle_mcp_request(request: Request):
    """MCPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’å—ã‘å–ã‚‹"""
    data = await request.json()
    sender = data.get("sender", "Unknown")
    task = data.get("task", "No Task")
    
    print(f"[{AGENT_NAME}] Received task from {sender}: {task}")
    
    if "å®Ÿè£…ã›ã‚ˆ" in task:
        # ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        result_message = f"ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚å¤–éƒ¨ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
        
        # å¤–éƒ¨ç’°å¢ƒã§ã®çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        test_result = await run_integration_test()
        
        # TesterAgentã«çµæœã‚’å ±å‘Š
        response = requests.post(TESTER_URL, json={
            "sender": AGENT_NAME,
            "task": "çµ±åˆãƒ†ã‚¹ãƒˆã®çµæœã‚’æ¤œè¨¼ã›ã‚ˆ",
            "test_result": test_result,
            "external_env": {
                "php_url": EXTERNAL_PHP_URL,
                "mysql_url": EXTERNAL_MYSQL_URL,
                "redis_url": EXTERNAL_REDIS_URL
            }
        })
        
        return {
            "status": "processing", 
            "message": result_message, 
            "integration_test": test_result,
            "tester_response": response.json()
        }
        
    return {"status": "success", "result": f"{AGENT_NAME}ãŒã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚", "received_task": task}

async def run_integration_test():
    """å¤–éƒ¨é–‹ç™ºç’°å¢ƒã§ã®çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    try:
        # MySQLæ¥ç¶šãƒ†ã‚¹ãƒˆ
        mysql_result = subprocess.run([
            "mysql", "-h", EXTERNAL_MYSQL_URL.split(':')[0], 
            "-P", EXTERNAL_MYSQL_URL.split(':')[1],
            "-u", "root", "-ppassword", "-e", "SELECT 1;"
        ], capture_output=True, text=True)
        
        # Redisæ¥ç¶šãƒ†ã‚¹ãƒˆ
        redis_result = subprocess.run([
            "redis-cli", "-h", EXTERNAL_REDIS_URL.split(':')[0],
            "-p", EXTERNAL_REDIS_URL.split(':')[1], "ping"
        ], capture_output=True, text=True)
        
        # PHP ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ (HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ)
        php_response = requests.get(f"http://{EXTERNAL_PHP_URL}/health")
        
        return {
            "mysql_connection": mysql_result.returncode == 0,
            "redis_connection": "PONG" in redis_result.stdout,
            "php_application": php_response.status_code == 200,
            "details": {
                "mysql_output": mysql_result.stdout,
                "redis_output": redis_result.stdout,
                "php_status": php_response.status_code
            }
        }
    except Exception as e:
        return {
            "error": str(e),
            "mysql_connection": False,
            "redis_connection": False,
            "php_application": False
        }

if __name__ == "__main__":
    pass
```

