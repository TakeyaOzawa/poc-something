# アーキテクチャ改善タスクリスト

## 概要

このドキュメントは、アーキテクチャ解析レポートに基づいた改善タスクのリストです。各タスクは優先度、難易度、推定工数で分類されています。

## タスク分類

### 優先度

- 🔴 高: 早急に対応すべき重要な課題
- 🟡 中: 計画的に対応すべき課題
- 🟢 低: 余裕があれば対応する課題

### 難易度

- ⭐ 簡単: 1-2日
- ⭐⭐ 普通: 3-5日
- ⭐⭐⭐ 難しい: 1-2週間

---

## 🔴 優先度: 高

### [ ] 1. Presentation層のViewModel完全実装

- **優先度**: 🔴 高
- **難易度**: ⭐⭐⭐ 難しい
- **推定工数**: 2週間
- **担当者**: 未定
- **期限**: 未定

#### 背景

Presentation層が直接Domainエンティティをimportしている箇所が15ファイル以上存在し、レイヤー間の結合度が高い状態です。

#### 目標

- Presentation層専用のViewModelを完全実装
- DomainエンティティへのPresentation層からの直接参照を排除
- ViewModelMapperによる変換を徹底

#### サブタスク

- [ ] 1.1 ViewModelの型定義を作成
  - `src/presentation/types/viewmodels/`ディレクトリを作成
  - Website、AutomationVariables、XPath等の主要エンティティ用ViewModelを定義
  - _要件: すべてのDomainエンティティに対応するViewModelを作成_

- [ ] 1.2 ViewModelMapperの実装
  - `src/presentation/mappers/ViewModelMapper.ts`を拡張
  - Domain → ViewModel変換メソッドを実装
  - ViewModel → Domain変換メソッドを実装（必要な場合）
  - _要件: 双方向変換をサポート_

- [ ] 1.3 Presenterの修正
  - AutomationVariablesManagerPresenter
  - SystemSettingsPresenter
  - StorageSyncManagerPresenter
  - その他のPresenterクラス
  - _要件: Domainエンティティの代わりにViewModelを使用_

- [ ] 1.4 Viewの修正
  - 各Viewクラスのインターフェースを更新
  - ViewModelを受け取るように変更
  - _要件: Domainエンティティへの参照を完全に削除_

- [ ] 1.5 Handlerの修正
  - `src/presentation/background/handlers/`配下のハンドラー
  - AutoFillHandler、ExecuteWebsiteFromPopupHandler等
  - _要件: ViewModelを使用した実装に変更_

- [ ] 1.6 テストの更新
  - Presentation層のテストを更新
  - ViewModelを使用したテストに変更
  - _要件: すべてのテストが通過すること_

- [ ] 1.7 アーキテクチャテストの更新
  - `dependency-rules.test.ts`の厳格化
  - Presentation層からのDomainエンティティimportを完全に禁止
  - _要件: 例外なくテストが通過すること_

#### 完了条件

- [ ] Presentation層からDomainエンティティへの直接importが0件
- [ ] すべてのPresenterがViewModelを使用
- [ ] すべてのテストが通過
- [ ] アーキテクチャテストが通過

---

### [ ] 2. エラーハンドリングの統一

- **優先度**: 🔴 高
- **難易度**: ⭐⭐ 普通
- **推定工数**: 1週間
- **担当者**: 未定
- **期限**: 未定

#### 背景

`Result`型の使用が一部に限定されており、例外とResultの使い分けが不明確です。

#### 目標

- エラーハンドリング戦略の統一
- Resultパターンの全面適用
- エラーコードの体系化

#### サブタスク

- [ ] 2.1 エラーハンドリング戦略の文書化
  - `docs/error-handling-strategy.md`を作成
  - Resultパターンの使用ガイドライン
  - 例外を使用すべきケースの定義
  - _要件: チーム全体で合意された戦略_

- [ ] 2.2 Result型の拡張
  - `src/domain/values/result.value.ts`を拡張
  - エラーコードのサポート追加
  - エラーチェーンのサポート追加
  - _要件: より詳細なエラー情報を保持_

- [ ] 2.3 エラーコードの体系化
  - `src/domain/constants/ErrorCodes.ts`を拡張
  - カテゴリ別のエラーコード定義
  - エラーメッセージのi18n対応
  - _要件: すべてのエラーケースをカバー_

- [ ] 2.4 UseCaseのエラーハンドリング統一
  - すべてのUseCaseでResult型を使用
  - 例外をResultに変換
  - _要件: 一貫したエラーハンドリング_

- [ ] 2.5 Repositoryのエラーハンドリング統一
  - すべてのRepositoryでResult型を使用（既に実装済みの確認）
  - エラーコードの追加
  - _要件: 詳細なエラー情報の提供_

- [ ] 2.6 Presentation層のエラー表示改善
  - エラーコードに基づいたユーザーフレンドリーなメッセージ
  - エラーログの統一
  - _要件: ユーザーが理解しやすいエラー表示_

#### 完了条件

- [ ] エラーハンドリング戦略が文書化されている
- [ ] すべてのUseCaseとRepositoryでResult型を使用
- [ ] エラーコードが体系化されている
- [ ] すべてのテストが通過

---

### [ ] 3. Application層のDTO完全実装

- **優先度**: 🔴 高
- **難易度**: ⭐⭐ 普通
- **推定工数**: 1週間
- **担当者**: 未定
- **期限**: 未定

#### 背景

一部のUseCaseでDTOが不完全で、Domainエンティティを直接返すケースが存在します。

#### 目標

- 全UseCaseでのDTO使用の徹底
- Input/Output DTOの完全定義
- レイヤー間の結合度低減

#### サブタスク

- [ ] 3.1 既存DTOの棚卸し
  - `src/application/dtos/`配下のDTOをリストアップ
  - 不足しているDTOを特定
  - _要件: すべてのUseCaseに対応するDTOのリスト_

- [ ] 3.2 不足しているDTOの作成
  - Input DTO
  - Output DTO
  - _要件: すべてのUseCaseがDTOを持つ_

- [ ] 3.3 Mapperの実装
  - `src/application/mappers/`配下にMapperを作成
  - Domain → DTO変換
  - DTO → Domain変換
  - _要件: 双方向変換をサポート_

- [ ] 3.4 UseCaseの修正
  - Domainエンティティを直接返している箇所を修正
  - DTOを使用するように変更
  - _要件: すべてのUseCaseがDTOを使用_

- [ ] 3.5 テストの更新
  - DTOを使用したテストに更新
  - _要件: すべてのテストが通過_

#### 完了条件

- [ ] すべてのUseCaseがInput/Output DTOを持つ
- [ ] Domainエンティティを直接返すUseCaseが0件
- [ ] すべてのテストが通過

---

## 🟡 優先度: 中

### [ ] 4. Portディレクトリの整理

- **優先度**: 🟡 中
- **難易度**: ⭐⭐ 普通
- **推定工数**: 3日
- **担当者**: 未定
- **期限**: 未定

#### 背景

`domain/ports/`ディレクトリに1ファイルのみで、多くのインターフェースが`domain/types/`に配置されています。

#### 目標

- Portディレクトリの整理
- 命名規則の統一
- ヘキサゴナルアーキテクチャの明確化

#### サブタスク

- [ ] 4.1 Port候補の特定
  - `src/domain/types/`配下のインターフェースを確認
  - Portとして扱うべきインターフェースを特定
  - _要件: 外部システムとの境界を明確化_

- [ ] 4.2 Portの移動
  - `domain/types/`から`domain/ports/`へ移動
  - ファイル名を`*Port.ts`に統一
  - _要件: 一貫した命名規則_

- [ ] 4.3 インポートパスの更新
  - すべてのimport文を更新
  - `@domain/types/`から`@domain/ports/`へ
  - _要件: ビルドエラーが発生しないこと_

- [ ] 4.4 ドキュメントの作成
  - `docs/ports-and-adapters.md`を作成
  - 各Portの役割と対応するAdapterを文書化
  - _要件: 新規開発者が理解できるドキュメント_

- [ ] 4.5 テストの更新
  - インポートパスの更新
  - _要件: すべてのテストが通過_

#### 完了条件

- [ ] Portが`domain/ports/`に集約されている
- [ ] 命名規則が統一されている（\*Port.ts）
- [ ] ドキュメントが整備されている
- [ ] すべてのテストが通過

---

### [ ] 5. Aggregateの明示的定義

- **優先度**: 🟡 中
- **難易度**: ⭐⭐⭐ 難しい
- **推定工数**: 1週間
- **担当者**: 未定
- **期限**: 未定

#### 背景

DDDのAggregateパターンが明示的でなく、Aggregate Rootの識別が不明確です。

#### 目標

- Aggregateの明示的な定義
- Aggregate Rootの識別
- トランザクション境界の明確化

#### サブタスク

- [ ] 5.1 Aggregateの分析
  - 現在のエンティティ間の関係を分析
  - Aggregate候補を特定
  - Aggregate Rootを決定
  - _要件: ドメインモデルの整合性を保つ_

- [ ] 5.2 Aggregateの文書化
  - `docs/domain-model.md`を作成
  - 各Aggregateの境界を図示
  - Aggregate Root、Entity、Value Objectの関係を明記
  - _要件: チーム全体で合意されたドメインモデル_

- [ ] 5.3 Aggregate基底クラスの作成
  - `src/domain/entities/AggregateRoot.ts`を作成
  - 共通機能の実装（ID管理、イベント発行等）
  - _要件: すべてのAggregate Rootが継承_

- [ ] 5.4 既存エンティティの再構成
  - Aggregate Rootを明示的に定義
  - Aggregateの境界を守るようにリファクタリング
  - _要件: データ整合性が保たれる_

- [ ] 5.5 Repositoryの見直し
  - Aggregate単位でのRepository定義
  - トランザクション境界の明確化
  - _要件: Aggregate全体を保存/取得_

- [ ] 5.6 テストの更新
  - Aggregateの整合性をテスト
  - _要件: すべてのテストが通過_

#### 完了条件

- [ ] Aggregateが明示的に定義されている
- [ ] Aggregate Rootが識別されている
- [ ] ドメインモデルが文書化されている
- [ ] すべてのテストが通過

---

### [ ] 6. アーキテクチャドキュメントの整備

- **優先度**: 🟡 中
- **難易度**: ⭐⭐ 普通
- **推定工数**: 5日
- **担当者**: 未定
- **期限**: 未定

#### 背景

アーキテクチャ決定記録（ADR）が存在せず、レイヤー間の通信フローが文書化されていません。

#### 目標

- ADRの作成
- アーキテクチャ図の作成
- 開発者ガイドの整備

#### サブタスク

- [ ] 6.1 ADRテンプレートの作成
  - `docs/adr/template.md`を作成
  - ADRの記録方法を定義
  - _要件: 標準的なADRフォーマット_

- [ ] 6.2 既存の設計決定をADRとして記録
  - クリーンアーキテクチャの採用
  - DIコンテナの実装
  - Resultパターンの採用
  - その他の重要な決定
  - _要件: 最低5件のADRを作成_

- [ ] 6.3 アーキテクチャ図の作成
  - `docs/architecture-diagrams.md`を作成
  - レイヤー構造図
  - データフロー図
  - コンポーネント図
  - _要件: Mermaid形式で作成_

- [ ] 6.4 開発者ガイドの作成
  - `docs/developer-guide.md`を作成
  - プロジェクト構造の説明
  - 新機能の追加方法
  - テストの書き方
  - _要件: 新規開発者が1日で理解できる内容_

- [ ] 6.5 コーディング規約の文書化
  - `docs/coding-conventions.md`を作成
  - 命名規則
  - ファイル配置ルール
  - コメント規約
  - _要件: チーム全体で合意された規約_

#### 完了条件

- [ ] ADRが5件以上作成されている
- [ ] アーキテクチャ図が作成されている
- [ ] 開発者ガイドが作成されている
- [ ] コーディング規約が文書化されている

---

### [ ] 7. Domain Serviceのステートレス化

- **優先度**: 🟡 中
- **難易度**: ⭐ 簡単
- **推定工数**: 2日
- **担当者**: 未定
- **期限**: 未定

#### 背景

一部のDomain Serviceがインスタンス変数を持ち、ステートレスでない状態です。

#### 目標

- Domain Serviceのステートレス化
- 状態が必要な場合はEntityへの移動

#### サブタスク

- [ ] 7.1 状態を持つDomain Serviceの特定
  - `src/domain/services/`配下を調査
  - インスタンス変数を持つサービスをリストアップ
  - _要件: すべての状態を持つサービスを特定_

- [ ] 7.2 リファクタリング計画の策定
  - 各サービスの状態の必要性を評価
  - Entityへの移動 or パラメータ化を決定
  - _要件: データ整合性を保つ計画_

- [ ] 7.3 リファクタリングの実施
  - 状態をEntityに移動
  - またはメソッドパラメータとして渡す
  - _要件: ステートレスなサービス_

- [ ] 7.4 テストの更新
  - リファクタリング後のテストを更新
  - _要件: すべてのテストが通過_

#### 完了条件

- [ ] すべてのDomain Serviceがステートレス
- [ ] 必要な状態はEntityに移動
- [ ] すべてのテストが通過

---

## 🟢 優先度: 低

### [ ] 8. テストカバレッジの可視化

- **優先度**: 🟢 低
- **難易度**: ⭐ 簡単
- **推定工数**: 1日
- **担当者**: 未定
- **期限**: 未定

#### 背景

アーキテクチャテストは優秀ですが、ビジネスロジックのテストカバレッジが不明です。

#### 目標

- カバレッジレポートの定期生成
- カバレッジ目標の設定

#### サブタスク

- [ ] 8.1 カバレッジツールの設定
  - Jest設定にカバレッジオプションを追加
  - カバレッジ閾値の設定
  - _要件: 自動的にカバレッジレポートを生成_

- [ ] 8.2 カバレッジレポートの可視化
  - HTMLレポートの生成
  - CI/CDでのカバレッジ表示
  - _要件: 視覚的に分かりやすいレポート_

- [ ] 8.3 カバレッジ目標の設定
  - Domain層: 90%以上
  - Application層: 85%以上
  - Infrastructure層: 75%以上
  - _要件: チーム全体で合意された目標_

- [ ] 8.4 CI/CDへの統合
  - カバレッジチェックをCI/CDに追加
  - 閾値を下回る場合はビルド失敗
  - _要件: 自動的なカバレッジチェック_

#### 完了条件

- [ ] カバレッジレポートが自動生成される
- [ ] カバレッジ目標が設定されている
- [ ] CI/CDでカバレッジチェックが実行される

---

### [ ] 9. パフォーマンス最適化

- **優先度**: 🟢 低
- **難易度**: ⭐⭐ 普通
- **推定工数**: 3日
- **担当者**: 未定
- **期限**: 未定

#### 背景

現時点でパフォーマンス問題は報告されていませんが、予防的な最適化を検討します。

#### 目標

- パフォーマンスボトルネックの特定
- 最適化の実施

#### サブタスク

- [ ] 9.1 パフォーマンス計測の実装
  - `src/infrastructure/performance/`配下に計測ツールを実装
  - 主要な処理の実行時間を計測
  - _要件: 本番環境でのパフォーマンス可視化_

- [ ] 9.2 ボトルネックの特定
  - 計測データの分析
  - 遅い処理の特定
  - _要件: 改善すべき箇所のリスト_

- [ ] 9.3 最適化の実施
  - キャッシュの導入
  - 不要な処理の削減
  - バッチ処理の最適化
  - _要件: 体感できる速度改善_

- [ ] 9.4 パフォーマンステストの追加
  - 大量データでのテスト
  - レスポンスタイムの検証
  - _要件: パフォーマンス劣化の防止_

#### 完了条件

- [ ] パフォーマンス計測が実装されている
- [ ] ボトルネックが特定され改善されている
- [ ] パフォーマンステストが追加されている

---

### [ ] 10. Bounded Contextの明確化

- **優先度**: 🟢 低
- **難易度**: ⭐⭐⭐ 難しい
- **推定工数**: 1週間
- **担当者**: 未定
- **期限**: 未定

#### 背景

DDDのBounded Contextの境界が不明確です。

#### 目標

- Bounded Contextの識別
- Context間の関係の明確化
- Context Mapの作成

#### サブタスク

- [ ] 10.1 Bounded Contextの分析
  - 現在のドメインモデルを分析
  - Bounded Context候補を特定
  - _要件: ビジネス要件に基づいた境界_

- [ ] 10.2 Context Mapの作成
  - `docs/context-map.md`を作成
  - Context間の関係を図示
  - 統合パターンを定義
  - _要件: チーム全体で合意されたContext Map_

- [ ] 10.3 モジュール構造の見直し
  - Bounded Context単位でのモジュール分割
  - Context間の依存関係の整理
  - _要件: 疎結合なモジュール構造_

- [ ] 10.4 Anti-Corruption Layerの実装
  - Context間の変換層を実装
  - 各Contextの独立性を保つ
  - _要件: Context間の影響を最小化_

#### 完了条件

- [ ] Bounded Contextが明確に定義されている
- [ ] Context Mapが作成されている
- [ ] モジュール構造がBounded Contextに対応している

---

## 進捗管理

### 完了タスク数

- 🔴 高: 0/3
- 🟡 中: 0/4
- 🟢 低: 0/3
- **合計**: 0/10

### 全体進捗

- [ ] 0% 完了

---

## 注意事項

1. **段階的な実施**: すべてのタスクを一度に実施するのではなく、優先度に従って段階的に実施してください。

2. **テストの維持**: 各タスクの実施後、必ずすべてのテストが通過することを確認してください。

3. **レビュー**: 重要な変更（優先度: 高）は、必ず複数人でレビューしてください。

4. **ドキュメント更新**: コードの変更に伴い、関連するドキュメントも更新してください。

5. **後方互換性**: 既存の機能を壊さないよう、後方互換性に注意してください。

---

## 次のアクション

1. このタスクリストをチームで確認
2. 各タスクの担当者と期限を決定
3. 優先度: 高のタスクから着手
4. 定期的な進捗確認ミーティングの設定

---

最終更新日: 2024年11月22日
