# データ同期機能 - ユーザーマニュアル

**最終更新日**: 2025-01-18
**バージョン**: 1.0.0
**対象ユーザー**: Auto Fill Tool 拡張機能の利用者

---

## 📋 目次

1. [はじめに](#1-はじめに)
2. [データ同期機能とは](#2-データ同期機能とは)
3. [データ同期設定画面へのアクセス](#3-データ同期設定画面へのアクセス)
4. [同期設定の作成](#4-同期設定の作成)
5. [手動同期の実行](#5-手動同期の実行)
6. [定期自動同期の設定](#6-定期自動同期の設定)
7. [CSV同期の使い方](#7-csv同期の使い方)
8. [外部DB同期の使い方](#8-外部db同期の使い方)
9. [競合解決の設定](#9-競合解決の設定)
10. [同期履歴の確認](#10-同期履歴の確認)
11. [トラブルシューティング](#11-トラブルシューティング)
12. [ベストプラクティス](#12-ベストプラクティス)
13. [よくある質問(FAQ)](#13-よくある質問faq)

---

## 1. はじめに

このマニュアルでは、Auto Fill Toolのデータ同期機能の使い方を詳しく説明します。

### 1.1 このマニュアルの使い方

- **初めて使う方**: セクション2～5を順番に読んでください
- **特定の機能を知りたい方**: 目次から該当セクションに移動してください
- **問題が発生した方**: セクション11「トラブルシューティング」を確認してください

### 1.2 前提知識

このマニュアルでは、以下の知識があることを前提としています：
- Chrome拡張機能の基本的な使い方
- CSV形式の理解
- REST API の基本概念（外部DB同期を使う場合）

---

## 2. データ同期機能とは

### 2.1 概要

データ同期機能は、Auto Fill Toolに保存されたデータ（自動化変数、Webサイト設定、XPath設定など）を**外部のデータソース**と同期する機能です。

### 2.2 できること

✅ **CSVファイルとの同期**:
- ローカルファイルからデータをインポート
- データをCSVファイルにエクスポート

✅ **外部データベース（API）との同期**:
- Notion、Google Sheets、カスタムAPIとの連携
- 双方向同期（送信・受信）
- 定期自動同期

✅ **競合解決**:
- ローカルとリモートのデータが異なる場合の解決ポリシー設定

### 2.3 メリット

- 📦 **バックアップ**: データを外部に保存して万が一に備える
- 🔄 **複数デバイス間の同期**: 複数のPCで同じ設定を共有
- 👥 **チーム共有**: チームメンバー間でデータを共有
- 🤖 **自動化**: 定期的に自動でデータを同期

---

## 3. データ同期設定画面へのアクセス

### 3.1 システム設定から開く

1. Chrome拡張機能のアイコンをクリック
2. ポップアップメニューから「⚙️ システム設定」をクリック
3. 上部のタブから「🔄 データ同期」タブをクリック

### 3.2 直接URLで開く

```
chrome-extension://[拡張機能ID]/system-settings.html#data-sync
```

---

## 4. 同期設定の作成

### 4.1 新規作成の手順

1. データ同期タブの「➕ 新しい同期設定を追加」ボタンをクリック
2. 基本設定を入力：
   - **設定名**: 分かりやすい名前（例: "Notion自動化変数同期"）
   - **説明**: この設定の目的（任意）
   - **同期対象**: どのデータを同期するか選択
     - 自動化変数（Automation Variables）
     - Webサイト設定（Websites）
     - XPath設定（XPaths）
     - システム設定（System Settings）

3. 同期方法を選択：
   - **CSV同期**: ローカルファイルを使う
   - **外部DB同期**: Notion、Google Sheets、カスタムAPIを使う

4. 同期タイミングを選択：
   - **手動**: ボタンを押した時だけ同期
   - **定期自動**: 指定した間隔で自動的に同期

5. 同期方向を選択：
   - **双方向**: ローカル→リモート、リモート→ローカル両方
   - **受信のみ**: リモート→ローカルのみ
   - **送信のみ**: ローカル→リモートのみ

6. 詳細設定を入力（同期方法により異なる - セクション7, 8参照）

7. 「💾 保存」ボタンをクリック

### 4.2 設定の編集

既存の同期設定カードの「✏️ 編集」ボタンをクリックすると、設定を変更できます。

### 4.3 設定の削除

既存の同期設定カードの「🗑️ 削除」ボタンをクリックすると、設定を削除できます。

**注意**: 削除すると復元できません。確認ダイアログで「OK」をクリックする前に、本当に削除してよいか確認してください。

---

## 5. 手動同期の実行

### 5.1 実行手順

1. データ同期タブで対象の同期設定カードを見つける
2. 「🔄 今すぐ同期」ボタンをクリック
3. 進捗状況が表示されます
4. 完了すると「✅ 同期成功」と表示されます

### 5.2 同期結果の確認

同期が完了すると、以下の情報が表示されます：

- **受信件数**: リモートから取得したデータ数
- **送信件数**: リモートに送信したデータ数
- **同期時刻**: 同期を実行した日時
- **ステータス**: 成功 / 失敗

### 5.3 エラー発生時

エラーが発生した場合、赤い「❌ 同期失敗」メッセージが表示されます。
エラーの詳細を確認して、セクション11「トラブルシューティング」を参照してください。

---

## 6. 定期自動同期の設定

### 6.1 定期同期の有効化

1. 同期設定作成・編集時に「同期タイミング」で「定期自動」を選択
2. 「同期間隔（分）」を入力（最小値: 1分）
3. 設定を保存

### 6.2 定期同期の動作

- バックグラウンドで自動的に実行されます
- Chrome拡張機能が有効な限り、定期的に同期が実行されます
- PCがスリープ状態の場合は実行されません（起動後に実行）

### 6.3 定期同期の一時停止

定期同期を一時停止したい場合：
1. 同期設定を編集
2. 「有効/無効」トグルスイッチを「無効」にする
3. 保存

**注意**: 定期同期は外部DB同期のみ対応しています。CSV同期は手動のみです。

### 6.4 バッテリー消費について

定期同期を短い間隔（例: 1分）に設定すると、バッテリー消費が増える可能性があります。
推奨間隔: **30分～60分**

---

## 7. CSV同期の使い方

### 7.1 CSV同期の特徴

- ✅ シンプルで分かりやすい
- ✅ オフラインで使える
- ✅ Excel、スプレッドシートで編集可能
- ⚠️ 定期自動同期は非対応（手動のみ）

### 7.2 CSVインポート（受信）

#### 手順

1. 同期設定で「同期方向」を「受信のみ」または「双方向」に設定
2. CSV設定を入力：
   - **文字コード**: UTF-8 / Shift-JIS / EUC-JP
   - **区切り文字**: カンマ / セミコロン / タブ
   - **ヘッダー行**: あり / なし
3. 「💾 保存」ボタンをクリック
4. 同期設定カードの「📥 CSVインポート」ボタンをクリック
5. CSVファイルを選択

#### CSVファイルの形式

**自動化変数の例:**
```csv
id,name,value,description
1,ユーザー名,test_user,テストユーザーのログイン名
2,パスワード,password123,テストユーザーのパスワード
```

**注意**:
- 1行目はヘッダー行（カラム名）
- 2行目以降がデータ行
- 必須カラム: `id`, `name`, `value`

詳細なCSVフォーマットは[CSV_FORMAT_EXAMPLES.md](./CSV_FORMAT_EXAMPLES.md)を参照してください。

### 7.3 CSVエクスポート（送信）

#### 手順

1. 同期設定で「同期方向」を「送信のみ」または「双方向」に設定
2. CSV設定を入力（インポートと同じ）
3. 「💾 保存」ボタンをクリック
4. 同期設定カードの「📤 CSVエクスポート」ボタンをクリック
5. ダウンロード先を選択してファイルを保存

---

## 8. 外部DB同期の使い方

### 8.1 外部DB同期の特徴

- ✅ リアルタイム同期可能
- ✅ 定期自動同期対応
- ✅ 双方向同期可能
- ⚠️ APIキーや認証情報が必要

### 8.2 対応している外部サービス

- **Notion**: Notionデータベースと同期
- **Google Sheets**: Googleスプレッドシートと同期
- **カスタムAPI**: 任意のREST APIと同期

### 8.3 Notion同期の設定

#### 8.3.1 Notion APIキーの取得

1. [Notion Integrations](https://www.notion.so/my-integrations)にアクセス
2. 「+ 新しいインテグレーション」をクリック
3. インテグレーション名を入力（例: "Auto Fill Tool"）
4. 「Submit」をクリック
5. 「Internal Integration Token」をコピー

#### 8.3.2 Notionデータベースの準備

1. Notionで新しいデータベースを作成
2. データベースのプロパティを設定：
   - `id` (Text): 必須
   - `name` (Text): 必須
   - `value` (Text): 必須
   - `description` (Text): 任意
3. データベースをインテグレーションに共有：
   - データベース右上の「•••」→「接続を追加」
   - 作成したインテグレーションを選択

#### 8.3.3 Auto Fill Toolでの設定

1. 同期設定で「同期方法」を「Notion」に設定
2. 認証情報を入力：
   - **APIキー**: コピーしたIntegration Token
3. 受信ステップを設定（JSON形式）：
```json
[
  {
    "id": "fetch-data",
    "name": "Notionデータ取得",
    "method": "POST",
    "url": "https://api.notion.com/v1/databases/{DATABASE_ID}/query",
    "headers": {
      "Content-Type": "application/json"
    },
    "responseMapping": {
      "dataPath": "$.results[*]"
    }
  }
]
```

4. 送信ステップを設定（双方向同期の場合）
5. 「💾 保存」ボタンをクリック

詳細なNotion API設定例は[API_CONFIGURATION_EXAMPLES.md](./API_CONFIGURATION_EXAMPLES.md#notion-api)を参照してください。

### 8.4 Google Sheets同期の設定

#### 8.4.1 Google Sheets APIの有効化

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを作成（または既存プロジェクトを選択）
3. 「APIとサービス」→「ライブラリ」から「Google Sheets API」を有効化
4. 「認証情報」から「OAuthクライアントID」を作成
5. アクセストークンを取得

#### 8.4.2 Auto Fill Toolでの設定

1. 同期設定で「同期方法」を「Google Sheets」に設定
2. 認証情報を入力：
   - **アクセストークン**: 取得したOAuthトークン
3. 受信ステップを設定（JSON形式）：
```json
[
  {
    "id": "fetch-sheets",
    "name": "Sheetsデータ取得",
    "method": "GET",
    "url": "https://sheets.googleapis.com/v4/spreadsheets/{SPREADSHEET_ID}/values/{RANGE}",
    "responseMapping": {
      "dataPath": "$.values[*]"
    }
  }
]
```

詳細なGoogle Sheets API設定例は[API_CONFIGURATION_EXAMPLES.md](./API_CONFIGURATION_EXAMPLES.md#google-sheets-api)を参照してください。

### 8.5 カスタムAPI同期の設定

独自のREST APIと同期する場合：

1. 同期設定で「同期方法」を「カスタムAPI」に設定
2. 認証方式を選択：
   - **Bearer Token**: `Authorization: Bearer {token}`
   - **API Key**: `X-API-Key: {key}`
   - **Basic認証**: `Authorization: Basic {base64(username:password)}`
   - **カスタムヘッダー**: 任意のヘッダー
3. 受信・送信ステップを設定（JSON形式）

---

## 9. 競合解決の設定

### 9.1 競合とは

**競合**: ローカルとリモートのデータが異なる場合に発生します。

例：
- ローカル: `{"name": "ユーザー名", "value": "user1"}`
- リモート: `{"name": "ユーザー名", "value": "user2"}`

### 9.2 競合解決ポリシー

同期設定作成時に「競合解決」で以下のいずれかを選択します：

| ポリシー | 説明 | 使用例 |
|---------|------|--------|
| **最新タイムスタンプ優先** | 更新日時が新しい方を採用 | 最後に編集したデータを優先したい |
| **ローカル優先** | 常にローカルのデータを優先 | ローカルが正しいデータの場合 |
| **リモート優先** | 常にリモートのデータを優先 | リモートが正しいデータの場合 |
| **ユーザー確認** | 競合時にダイアログで確認 | 手動で判断したい（将来実装予定） |

### 9.3 詳細な競合解決ガイド

競合解決の詳細、具体例、ベストプラクティスは[CONFLICT_RESOLUTION_GUIDE.md](../CONFLICT_RESOLUTION_GUIDE.md)を参照してください。

---

## 10. 同期履歴の確認

### 10.1 同期履歴の表示

各同期設定カードの下部に、最近の同期履歴が表示されます：

- **同期日時**: いつ同期を実行したか
- **同期方向**: 受信 / 送信 / 双方向
- **ステータス**: 成功 / 失敗
- **受信件数 / 送信件数**: 同期したデータ数

### 10.2 履歴の詳細確認

同期履歴をクリックすると、詳細情報が表示されます：

- エラーメッセージ（失敗時）
- 同期にかかった時間
- 競合解決の結果

### 10.3 履歴のクリーンアップ

古い履歴は自動的に削除されます（デフォルト: 30日経過後）。

手動でクリーンアップする場合：
1. システム設定タブの「一般設定」を開く
2. 「同期履歴の保持期間」を設定
3. 「💾 保存」ボタンをクリック

---

## 11. トラブルシューティング

### 11.1 同期が失敗する

#### 問題: 「認証エラー」と表示される

**原因**: APIキーやトークンが無効、または期限切れ

**解決方法**:
1. 同期設定を編集
2. 認証情報（APIキー、アクセストークン）を再確認
3. 必要に応じて新しいAPIキーを取得
4. 「接続テスト」ボタンで接続を確認

#### 問題: 「ネットワークエラー」と表示される

**原因**: インターネット接続の問題、またはAPIサーバーダウン

**解決方法**:
1. インターネット接続を確認
2. APIサービスのステータスページを確認（Notion Status、Google Cloud Statusなど）
3. しばらく待ってから再試行

#### 問題: 「データ形式エラー」と表示される

**原因**: リモートのデータ形式が期待と異なる

**解決方法**:
1. リモートのデータ構造を確認
2. 受信ステップの`responseMapping.dataPath`を修正
3. 「接続テスト」ボタンで動作確認

### 11.2 データが正しく同期されない

#### 問題: データが空になる

**原因**: JSONPathの指定が間違っている、または競合解決で上書きされた

**解決方法**:
1. 受信ステップの`responseMapping.dataPath`を確認
2. APIのレスポンスをブラウザのDevToolsで確認
3. 競合解決ポリシーを確認

#### 問題: 一部のデータだけ同期される

**原因**: データ変換設定が不完全

**解決方法**:
1. データ変換設定を確認
2. フィールドマッピングが正しいか確認
3. 必須フィールドが欠けていないか確認

### 11.3 定期同期が動作しない

#### 問題: 定期同期が実行されない

**原因**: 同期設定が無効、またはChrome拡張機能が無効

**解決方法**:
1. 同期設定の「有効/無効」トグルを確認
2. Chrome拡張機能が有効になっているか確認
3. Chromeが起動しているか確認（PCスリープ中は動作しない）

### 11.4 CSVインポート/エクスポートが失敗する

#### 問題: 「CSVファイルの形式が正しくありません」と表示される

**原因**: CSVファイルのフォーマットが間違っている

**解決方法**:
1. CSVファイルをテキストエディタで開く
2. 1行目にヘッダー行があるか確認
3. 区切り文字が設定と一致しているか確認（カンマ、セミコロン、タブ）
4. 文字コードが正しいか確認（UTF-8推奨）
5. [CSV_FORMAT_EXAMPLES.md](./CSV_FORMAT_EXAMPLES.md)のサンプルと比較

#### 問題: 日本語が文字化けする

**原因**: 文字コードの不一致

**解決方法**:
1. CSVファイルの文字コードを確認
2. 同期設定の「文字コード」を変更（UTF-8 / Shift-JIS / EUC-JP）
3. Excel で開く場合は「UTF-8 BOM付き」で保存

### 11.5 エラーログの確認

詳細なエラーログを確認する場合：
1. Chromeの拡張機能ページを開く（`chrome://extensions/`）
2. Auto Fill Toolの「詳細」→「バックグラウンドページ」をクリック
3. DevToolsのConsoleタブでエラーメッセージを確認

---

## 12. ベストプラクティス

### 12.1 同期設定の命名規則

分かりやすい名前をつけましょう：

✅ **良い例**:
- "Notion自動化変数 - 毎日自動同期"
- "開発環境用 - CSV手動バックアップ"
- "本番環境 - Google Sheets双方向同期"

❌ **悪い例**:
- "設定1"
- "test"
- "同期"

### 12.2 定期同期の間隔設定

用途に応じて適切な間隔を設定しましょう：

| 用途 | 推奨間隔 | 理由 |
|------|---------|------|
| リアルタイム同期 | 5～10分 | 最新データが必要 |
| 通常のバックアップ | 30～60分 | バッテリー消費とバランス |
| 夜間バックアップ | 1日1回 | データ更新頻度が低い |

### 12.3 競合解決ポリシーの選び方

| シナリオ | 推奨ポリシー | 理由 |
|---------|------------|------|
| 個人利用 | 最新タイムスタンプ優先 | 最後の編集を優先 |
| チーム共有（リモートが正） | リモート優先 | チームの設定を優先 |
| チーム共有（ローカルが正） | ローカル優先 | 個人の設定を優先 |
| 重要なデータ | ユーザー確認 | 手動で判断（将来実装） |

### 12.4 セキュリティのベストプラクティス

✅ **推奨**:
- APIキーは定期的に更新
- 最小限の権限でAPIキーを作成
- パスワードなどの機密情報は同期しない

❌ **非推奨**:
- APIキーを他人と共有
- パブリックなAPIキーを使用
- 平文でパスワードを同期

### 12.5 バックアップ戦略

複数のバックアップ方法を組み合わせましょう：

1. **定期自動同期**: Notionに毎日自動バックアップ
2. **手動CSVエクスポート**: 重要な変更前にCSVでバックアップ
3. **ローカルバックアップ**: Chrome Storage のエクスポート機能を使う

---

## 13. よくある質問(FAQ)

### Q1: 同期設定はいくつまで作成できますか？

**A**: 制限はありませんが、パフォーマンスを考慮して10個程度までを推奨します。

---

### Q2: 定期同期の最小間隔は？

**A**: 1分です。ただし、バッテリー消費を考慮して30分以上を推奨します。

---

### Q3: 複数デバイスで同じ設定を使えますか？

**A**: はい。同じ外部DB（Notion、Google Sheetsなど）に接続することで、複数デバイス間でデータを同期できます。

---

### Q4: CSVファイルの最大サイズは？

**A**: 明確な上限はありませんが、10MB以上のファイルは処理が遅くなる可能性があります。

---

### Q5: APIキーはどこに保存されますか？

**A**: Chrome Storage Localに暗号化されて保存されます（マスターパスワード機能が有効な場合）。

---

### Q6: 同期中にChromeを閉じても大丈夫？

**A**: 手動同期の場合は完了を待つことを推奨します。定期同期の場合は次回の同期時に実行されます。

---

### Q7: Notion以外のAPIと連携できますか？

**A**: はい。REST APIであれば、カスタムAPI設定で任意のAPIと連携できます。

---

### Q8: 同期履歴はどのくらい保存されますか？

**A**: デフォルトでは30日間保存されます。設定で変更可能です。

---

### Q9: エラーが発生した場合、通知されますか？

**A**: 現在はChrome通知機能を使ってエラー通知を表示します（将来的にはメール通知も予定）。

---

### Q10: オフラインでも同期できますか？

**A**: CSV同期はオフラインで可能です。外部DB同期はインターネット接続が必要です。

---

## 14. サポート情報

### 14.1 関連ドキュメント

- [競合解決ガイド](../CONFLICT_RESOLUTION_GUIDE.md) - 競合解決の詳細説明
- [API設定例](./API_CONFIGURATION_EXAMPLES.md) - Notion、Google Sheets等の設定例
- [CSVフォーマット例](./CSV_FORMAT_EXAMPLES.md) - CSVファイルの形式例
- [セキュリティ設計書](../../外部データソース連携/SECURITY_DESIGN.md) - セキュリティの詳細
- [同期機能設計書](../../外部データソース連携/STORAGE_SYNC_DESIGN.md) - 技術的な設計詳細

### 14.2 問題報告

バグや問題を見つけた場合：
1. GitHubのIssuesページで報告
2. エラーメッセージのスクリーンショットを添付
3. 再現手順を詳しく記載

### 14.3 機能要望

新機能のリクエスト：
1. GitHubのIssuesページで「Feature Request」ラベルで投稿
2. 使用例と期待する動作を記載

---

**マニュアルの最終更新**: 2025-01-18
**バージョン**: 1.0.0
**フィードバック**: [GitHub Issues](https://github.com/your-repo/auto-fill-tool/issues)
